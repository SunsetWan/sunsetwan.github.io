<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sunsetwan.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="æœ€è¿‘æƒ³äº†è§£å¦‚ä½•è®¾è®¡ä¸€ä¸ªç®€å•çš„ç¼“å­˜ç³»ç»Ÿï¼Œäºæ˜¯æ‰¾äº† Kingfisher 7.1.2 ç‰ˆæœ¬çš„æºä»£ç è¯»ä¸€è¯»ï¼Œæœ‰äº›æ”¶è·ï¼Œè®°å½•äºæ­¤ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Kingfisher æºç é˜…è¯»ï¼ˆä¸€ï¼‰">
<meta property="og:url" content="https://sunsetwan.github.io/2022/03/28/Kingfisher%20%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/index.html">
<meta property="og:site_name" content="æ—¥è½å¤§é“">
<meta property="og:description" content="æœ€è¿‘æƒ³äº†è§£å¦‚ä½•è®¾è®¡ä¸€ä¸ªç®€å•çš„ç¼“å­˜ç³»ç»Ÿï¼Œäºæ˜¯æ‰¾äº† Kingfisher 7.1.2 ç‰ˆæœ¬çš„æºä»£ç è¯»ä¸€è¯»ï¼Œæœ‰äº›æ”¶è·ï¼Œè®°å½•äºæ­¤ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_01.jpg">
<meta property="og:image" content="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_02.png">
<meta property="og:image" content="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_03.png">
<meta property="article:published_time" content="2022-03-28T01:41:00.000Z">
<meta property="article:modified_time" content="2022-03-28T15:37:33.766Z">
<meta property="article:author" content="Sunset Wan">
<meta property="article:tag" content="Kingfisher">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_01.jpg">

<link rel="canonical" href="https://sunsetwan.github.io/2022/03/28/Kingfisher%20%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Kingfisher æºç é˜…è¯»ï¼ˆä¸€ï¼‰ | æ—¥è½å¤§é“</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">æ—¥è½å¤§é“</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sunsetwan.github.io/2022/03/28/Kingfisher%20%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sunset Wan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ—¥è½å¤§é“">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kingfisher æºç é˜…è¯»ï¼ˆä¸€ï¼‰
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-03-28 09:41:00 / ä¿®æ”¹æ—¶é—´ï¼š23:37:33" itemprop="dateCreated datePublished" datetime="2022-03-28T09:41:00+08:00">2022-03-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>æœ€è¿‘æƒ³äº†è§£å¦‚ä½•è®¾è®¡ä¸€ä¸ªç®€å•çš„ç¼“å­˜ç³»ç»Ÿï¼Œäºæ˜¯æ‰¾äº† Kingfisher 7.1.2 ç‰ˆæœ¬çš„æºä»£ç è¯»ä¸€è¯»ï¼Œæœ‰äº›æ”¶è·ï¼Œè®°å½•äºæ­¤ã€‚<a id="more"></a></p>
<p>ç¼“å­˜ç³»ç»Ÿä¸€èˆ¬å¯åˆ†ä¸ºï¼šå†…å­˜ç¼“å­˜ï¼ˆmemory cacheï¼‰å’Œç¡¬ç›˜ç¼“å­˜ï¼ˆdisk cacheï¼‰ã€‚</p>
<h2 id="å†…å­˜ç¼“å­˜"><a href="#å†…å­˜ç¼“å­˜" class="headerlink" title="å†…å­˜ç¼“å­˜"></a>å†…å­˜ç¼“å­˜</h2><p>å†…å­˜ç¼“å­˜èƒŒåæ”¯æ’‘çš„æ•°æ®ç»“æ„æ˜¯ Foundation æ¡†æ¶ä¸­çš„ <code>NSCache</code>ã€‚<br><code>NSCache</code> æœ‰ä¸¤ä¸ªé™åˆ¶ï¼š<code>countLimit</code> å’Œ <code>totalCostLimit</code>ã€‚å‰è€…æ˜¯è¡¨ç¤ºèƒ½å­˜å‚¨å¤šå°‘ä¸ªå¯¹è±¡ï¼Œåè€…æ˜¯è¡¨ç¤ºç¼“å­˜çš„å®¹é‡æœ‰å¤šå¤§ã€‚ä½†è¿™ä¸¤ä¸ªé™åˆ¶æ˜¯è½¯é™åˆ¶â€”â€”å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œ<code>NSCache</code> ä¸­ä¿å­˜çš„å¯¹è±¡ä¸ä¸€å®šä¼šè¢«åŠæ—¶åœ°ä»å…¶ä¸­ç§»å‡ºã€‚æ ¹æ® <a href="https://developer.apple.com/documentation/foundation/nscache?language=objc" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ï¼Œè¶…è¿‡é™åˆ¶ä¹‹åï¼Œå¯¹è±¡çš„ç§»å‡ºæ—¶æœºå–å†³ä¸ <code>NSCache</code> èƒŒåçš„å®ç°ã€‚</p>
<p><img src="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_01.jpg" alt="kf_01"></p>
<p><code>NSCache</code> æ˜¯ä¸ªèŒƒå‹ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—å®šä¹‰å¥½ <code>KeyType</code> å’Œ <code>ObjectType</code>ã€‚<br>æ ¹æ®å£°æ˜çš„ç±»å‹çº¦æŸï¼Œ<code>KeyType</code> çš„ç±»å‹å¾—æ˜¯ä¸€ä¸ªç±»ã€‚ä¸€èˆ¬åœ°ï¼Œç±»ä¼¼ key çš„æ•°æ®ç»“æ„ä¼šé‡‡ç”¨ <code>String</code>ã€‚è€Œè¿™é‡Œ <code>KeyType</code> å¾—æ˜¯å¼•ç”¨ç±»å‹è€Œä¸æ˜¯å€¼ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šé€‰æ‹© <code>NSString</code>ã€‚ä½†åœ¨ API è®¾è®¡æ—¶ï¼Œå¯¹å¤–æš´éœ²çš„é‚£ä¸€å±‚ APIï¼Œè¿˜æ˜¯å¯ä»¥ä½¿ç”¨ <code>String</code>ã€‚åˆ°è°ƒç”¨ <code>NSCache</code> çš„<code>setObject(_:forKey:cost:)</code> æ–¹æ³•æ—¶ï¼Œå†æŠŠ <code>String</code> è½¬ä¸º <code>NSString</code>ã€‚ä¹‹æ‰€ä»¥è¿™æ ·åšï¼Œæ˜¯å› ä¸ºå€¼ç±»å‹æ›´ç¬¦åˆå½“å‰åœºæ™¯çš„éœ€æ±‚ã€‚<br>Kingfisher ä¸­ <code>ObjectType</code> å¯¹åº”çš„æ•°æ®ç»“æ„æ˜¯è¿™ä¹ˆè®¾è®¡çš„ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StorageObject</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> value: <span class="type">T</span> <span class="comment">// å›¾ç‰‡çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">let</span> expiration: <span class="type">StorageExpiration</span> <span class="comment">// è¿‡æœŸç­–ç•¥</span></span><br><span class="line">    <span class="keyword">let</span> key: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> estimatedExpiration: <span class="type">Date</span> <span class="comment">// é¢„è®¡åˆ°æœŸæ—¶é—´</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> value: <span class="type">T</span>, key: <span class="type">String</span>, expiration: <span class="type">StorageExpiration</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value = value</span><br><span class="line">        <span class="keyword">self</span>.key = key</span><br><span class="line">        <span class="keyword">self</span>.expiration = expiration</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.estimatedExpiration = expiration.estimatedExpirationSinceNow</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®å½“å‰ç¼“å­˜å¯¹è±¡çš„ç»­æœŸç­–ç•¥ï¼Œè¿›è¡Œç»­æœŸã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">extendExpiration</span><span class="params">(<span class="number">_</span> extendingExpiration: ExpirationExtending = .cacheTime)</span></span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> extendingExpiration &#123;</span><br><span class="line">            <span class="keyword">case</span> .<span class="keyword">none</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">case</span> .cacheTime:</span><br><span class="line">            <span class="keyword">self</span>.estimatedExpiration = expiration.estimatedExpirationSinceNow</span><br><span class="line">            <span class="keyword">case</span> .expirationTime(<span class="keyword">let</span> expirationTime):</span><br><span class="line">            <span class="keyword">self</span>.estimatedExpiration = expirationTime.estimatedExpirationSinceNow</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> expired: <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> estimatedExpiration.isPast</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç¡¬ç›˜ç¼“å­˜"><a href="#ç¡¬ç›˜ç¼“å­˜" class="headerlink" title="ç¡¬ç›˜ç¼“å­˜"></a>ç¡¬ç›˜ç¼“å­˜</h2><p>æ‰€è°“ç¡¬ç›˜ç¼“å­˜ï¼Œå°±æ˜¯æŠŠç¼“å­˜æ•°æ®å†™å…¥ä¸€ä¸ªæ–‡ä»¶ã€‚å½“å¯¹è±¡å†™å…¥ç¡¬ç›˜ç¼“å­˜æ—¶ï¼Œéœ€è¦çš„æ˜¯å›¾ç‰‡çš„æ•°æ®ï¼Œç¼“å­˜çš„ Key ä»¥åŠè¿‡æœŸç­–ç•¥ï¼ˆStorageExpirationï¼‰ã€‚å†™å…¥æ–‡ä»¶çš„ URL æ˜¯é€šè¿‡ç¼“å­˜çš„ Key è®¡ç®—å¯å¾—ã€‚</p>
<p>Kingfisher åˆ©ç”¨æ“ä½œç³»ç»Ÿä¸­çš„æ–‡ä»¶ç³»ç»Ÿæ¥å¿«æ·åœ°å­˜å‚¨è¯¥ç¼“å­˜å¯¹è±¡çš„ <strong>ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´</strong> å’Œ <strong>é¢„è®¡åˆ°æœŸæ—¶é—´</strong>ã€‚Kingfisher æŠŠå†™å…¥æ–‡ä»¶çš„ <strong>åˆ›å»ºæ—¶é—´</strong> å†™ä¸º <strong>ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´</strong>ï¼ŒæŠŠå†™å…¥æ–‡ä»¶çš„ <strong>ä¿®æ”¹æ—¥æœŸ</strong> å†™ä¸º <strong>é¢„è®¡åˆ°æœŸæ—¶é—´</strong>ï¼Œè¿˜æŒºå·§å¦™çš„ ğŸ¤¯ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> now = <span class="type">Date</span>()</span><br><span class="line"><span class="keyword">let</span> attributes: [<span class="type">FileAttributeKey</span> : <span class="type">Any</span>] = [</span><br><span class="line">    <span class="comment">// The last access date.</span></span><br><span class="line">    .creationDate: now.fileAttributeDate,</span><br><span class="line">    <span class="comment">// The estimated expiration date.</span></span><br><span class="line">    .modificationDate: expiration.estimatedExpirationSinceNow.fileAttributeDate</span><br><span class="line">]</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> config.fileManager.setAttributes(attributes, ofItemAtPath: fileURL.path)</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">try</span>? config.fileManager.removeItem(at: fileURL)</span><br><span class="line">    <span class="keyword">throw</span> <span class="type">KingfisherError</span>.cacheError(</span><br><span class="line">        reason: .cannotSetCacheFileAttribute(</span><br><span class="line">            filePath: fileURL.path,</span><br><span class="line">            attributes: attributes,</span><br><span class="line">            error: error</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ä»ç¡¬ç›˜ä¸­è®¿é—®ç¼“å­˜æ—¶ï¼ŒKingfisher è®¾è®¡äº† <code>FileMeta</code> æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FileMeta</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> url: <span class="type">URL</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> lastAccessDate: <span class="type">Date?</span></span><br><span class="line">    <span class="keyword">let</span> estimatedExpirationDate: <span class="type">Date?</span></span><br><span class="line">    <span class="keyword">let</span> isDirectory: <span class="type">Bool</span></span><br><span class="line">    <span class="keyword">let</span> fileSize: <span class="type">Int</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(</span><br><span class="line">        fileURL: <span class="type">URL</span>,</span><br><span class="line">        lastAccessDate: <span class="type">Date?</span>,</span><br><span class="line">        estimatedExpirationDate: <span class="type">Date?</span>,</span><br><span class="line">        isDirectory: <span class="type">Bool</span>,</span><br><span class="line">        fileSize: <span class="type">Int</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">self</span>.url = fileURL</span><br><span class="line">        <span class="keyword">self</span>.lastAccessDate = lastAccessDate</span><br><span class="line">        <span class="keyword">self</span>.estimatedExpirationDate = estimatedExpirationDate</span><br><span class="line">        <span class="keyword">self</span>.isDirectory = isDirectory</span><br><span class="line">        <span class="keyword">self</span>.fileSize = fileSize</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">expired</span><span class="params">(referenceDate: Date)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> estimatedExpirationDate?.isPast(referenceDate: referenceDate) ?? <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®å½“å‰ç¼“å­˜å¯¹è±¡çš„ç»­æœŸç­–ç•¥ï¼Œè¿›è¡Œç»­æœŸã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">extendExpiration</span><span class="params">(with fileManager: FileManager, extendingExpiration: ExpirationExtending)</span></span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> lastAccessDate = lastAccessDate,</span><br><span class="line">        <span class="keyword">let</span> lastEstimatedExpiration = estimatedExpirationDate <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> attributes: [<span class="type">FileAttributeKey</span> : <span class="type">Any</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> extendingExpiration &#123;</span><br><span class="line">            <span class="keyword">case</span> .<span class="keyword">none</span>:</span><br><span class="line">            <span class="comment">// not extending expiration time here</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">case</span> .cacheTime:</span><br><span class="line">            <span class="keyword">let</span> originalExpiration: <span class="type">StorageExpiration</span> =</span><br><span class="line">            .seconds(lastEstimatedExpiration.timeIntervalSince(lastAccessDate))</span><br><span class="line">            attributes = [</span><br><span class="line">                .creationDate: <span class="type">Date</span>().fileAttributeDate,</span><br><span class="line">                .modificationDate: originalExpiration.estimatedExpirationSinceNow.fileAttributeDate</span><br><span class="line">            ]</span><br><span class="line">            <span class="keyword">case</span> .expirationTime(<span class="keyword">let</span> expirationTime):</span><br><span class="line">            attributes = [</span><br><span class="line">                .creationDate: <span class="type">Date</span>().fileAttributeDate,</span><br><span class="line">                .modificationDate: expirationTime.estimatedExpirationSinceNow.fileAttributeDate</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>? fileManager.setAttributes(attributes, ofItemAtPath: url.path)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸éš¾çœ‹å‡ºï¼š<code>FileMeta</code> çš„è®¾è®¡æ€è·¯ä¸ <code>StorageObject</code> çš„è®¾è®¡æ€è·¯æœ‰ä¸å°‘ç›¸ä¼¼çš„åœ°æ–¹ã€‚</p>
<h2 id="ç¼“å­˜è¿‡æœŸç­–ç•¥"><a href="#ç¼“å­˜è¿‡æœŸç­–ç•¥" class="headerlink" title="ç¼“å­˜è¿‡æœŸç­–ç•¥"></a>ç¼“å­˜è¿‡æœŸç­–ç•¥</h2><p>Kingfisher æœ‰è®¾è®¡ 5 ç§ç¼“å­˜å¯¹è±¡çš„è¿‡æœŸç­–ç•¥ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">StorageExpiration</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> never <span class="comment">// ç¼“å­˜å¯¹è±¡æ°¸ä¸è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">case</span> seconds(<span class="type">TimeInterval</span>) <span class="comment">// ç¼“å­˜å¯¹è±¡åœ¨å½“å‰æ—¶é—´ç‚¹åçš„ x ç§’è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">case</span> days(<span class="type">Int</span>) <span class="comment">// ç¼“å­˜å¯¹è±¡åœ¨å½“å‰æ—¶é—´ç‚¹åçš„ x å¤©è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">case</span> date(<span class="type">Date</span>) <span class="comment">// ç¼“å­˜å¯¹è±¡åœ¨æŒ‡å®š Date è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">case</span> expired <span class="comment">// ç¼“å­˜å¯¹è±¡å·²è¿‡æœŸ</span></span><br><span class="line">		...</span><br><span class="line">		...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç¼“å­˜ç»­æœŸç­–ç•¥"><a href="#ç¼“å­˜ç»­æœŸç­–ç•¥" class="headerlink" title="ç¼“å­˜ç»­æœŸç­–ç•¥"></a>ç¼“å­˜ç»­æœŸç­–ç•¥</h2><p>æ ¹æ®ç¨‹åºå±€éƒ¨æ€§çš„åŸç†ï¼Œè¢«è®¿é—®è¿‡çš„ç¼“å­˜å¾ˆæœ‰å¯èƒ½å†è¢«è®¿é—®ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¹Ÿåº”æœ‰ç¼“å­˜ç»­æœŸç­–ç•¥ã€‚<br>Kingfisher æœ‰è®¾è®¡ 3 ç§ç¼“å­˜ç»­æœŸç­–ç•¥ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">ExpirationExtending</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">none</span> <span class="comment">// ä¸ç»­æœŸï¼Œåˆ°æœŸæ—¶é—´ä¸å˜</span></span><br><span class="line">    <span class="keyword">case</span> cacheTime <span class="comment">// ä»¥å½“å‰æ—¶é—´ç‚¹ä¸ºåŸºç¡€ç»­æœŸ</span></span><br><span class="line">    <span class="keyword">case</span> expirationTime(<span class="number">_</span> expiration: <span class="type">StorageExpiration</span>) <span class="comment">// ä»¥æŒ‡å®šåˆ°æœŸç­–ç•¥ç»­æœŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ— è®ºæ˜¯å†…å­˜ç¼“å­˜è¿˜æ˜¯ç¡¬ç›˜ç¼“å­˜ï¼Œé»˜è®¤çš„ç¼“å­˜ç»­æœŸç­–ç•¥å‡ä¸ºï¼š<code>cacheTime</code>ã€‚</p>
<h2 id="ç¼“å­˜æ¸…é™¤ç­–ç•¥"><a href="#ç¼“å­˜æ¸…é™¤ç­–ç•¥" class="headerlink" title="ç¼“å­˜æ¸…é™¤ç­–ç•¥"></a>ç¼“å­˜æ¸…é™¤ç­–ç•¥</h2><h3 id="å†…å­˜ç¼“å­˜æ¸…é™¤ç­–ç•¥"><a href="#å†…å­˜ç¼“å­˜æ¸…é™¤ç­–ç•¥" class="headerlink" title="å†…å­˜ç¼“å­˜æ¸…é™¤ç­–ç•¥"></a>å†…å­˜ç¼“å­˜æ¸…é™¤ç­–ç•¥</h3><p>å†…å­˜ç¼“å­˜çš„æ¸…é™¤ç­–ç•¥åˆ†ä¸ºä¸¤ç§ï¼š</p>
<ol>
<li>ç³»ç»Ÿæ§åˆ¶ï¼šè¶…è¿‡ <code>NSCache</code> çš„â€œè½¯é™åˆ¶â€ï¼Œç³»ç»Ÿè‡ªåŠ¨æ¸…é™¤ã€‚</li>
<li>è‡ªå·±æ§åˆ¶ï¼šå®šæœŸæ‰«æå·²ç¼“å­˜çš„å¯¹è±¡ï¼Œç§»å‡ºå·²è¿‡æœŸçš„å¯¹è±¡ã€‚</li>
</ol>
<p>å¯¹äºç¼“å­˜ç³»ç»Ÿæ¥è¯´ï¼Œç­–ç•¥ 1 æ˜¯å¯èƒ½æœ‰è´Ÿé¢å½±å“çš„ï¼Œå› ä¸ºç³»ç»Ÿå¯èƒ½ä¼šæ¸…é™¤ä¸€ä¸ªä»æœªè¿‡æœŸçš„å¯¹è±¡ï¼Œä»è€Œé™ä½äº†ç¼“å­˜çš„å‘½ä¸­ç‡ã€‚å¯è¡Œçš„è§£å†³åŠæ³•æ˜¯ï¼šæé«˜ <code>NSCache</code> çš„ <code>totalCostLimit</code>ã€‚ç„¶è€Œè¿™ä¼šå¯¼è‡´ç¼“å­˜å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜å˜å¤§ï¼Œéœ€è¦è‡ªå·±æŠŠæ¡è¿™ä¹‹é—´çš„å¹³è¡¡ã€‚</p>
<p>å†…å­˜ç¼“å­˜çš„å¯¹è±¡é»˜è®¤çš„æœ‰æ•ˆæœŸæ˜¯ 5 åˆ†é’Ÿã€‚å…³äºç­–ç•¥ 2ï¼ŒKingfisher è®¾è®¡äº†ä¸€ä¸ª <code>timer</code> æ¥å‘¨æœŸæ€§ï¼ˆé»˜è®¤å‘¨æœŸä¸º 2 åˆ†é’Ÿï¼‰åœ°æ¸…é™¤è¿‡æœŸçš„ç¼“å­˜å¯¹è±¡ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cleanTimer = .scheduledTimer(withTimeInterval: config.cleanInterval, repeats: <span class="literal">true</span>) &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    <span class="keyword">self</span>.removeExpired()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">removeExpired</span><span class="params">()</span></span> &#123;</span><br><span class="line">    lock.lock()</span><br><span class="line">    <span class="keyword">defer</span> &#123; lock.unlock() &#125;</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> keys &#123;</span><br><span class="line">        <span class="keyword">let</span> nsKey = key <span class="keyword">as</span> <span class="type">NSString</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> object = storage.object(forKey: nsKey) <span class="keyword">else</span> &#123;</span><br><span class="line">            keys.remove(key)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> object.estimatedExpiration.isPast &#123;</span><br><span class="line">            storage.removeObject(forKey: nsKey)</span><br><span class="line">            keys.remove(key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¡¬ç›˜ç¼“å­˜æ¸…é™¤ç­–ç•¥"><a href="#ç¡¬ç›˜ç¼“å­˜æ¸…é™¤ç­–ç•¥" class="headerlink" title="ç¡¬ç›˜ç¼“å­˜æ¸…é™¤ç­–ç•¥"></a>ç¡¬ç›˜ç¼“å­˜æ¸…é™¤ç­–ç•¥</h3><p>ç¡¬ç›˜ç¼“å­˜çš„å¯¹è±¡é»˜è®¤çš„æœ‰æ•ˆæœŸæ˜¯ 7 å¤©ï¼Œå…¶æ¸…é™¤ç­–ç•¥æ˜¯è‡ªå·±æ§åˆ¶çš„ã€‚<br>ç±»ä¼¼åœ°ï¼ŒKingfisher ä¹Ÿå¯¹ç¡¬ç›˜ç¼“å­˜çš„å¯ç”¨å®¹é‡åšäº†é™åˆ¶ï¼Œé€šè¿‡ <code>sizeLimit</code> æ¥æ§åˆ¶ã€‚ä½† Kingfisher åœ¨å¯¹è±¡å­˜å…¥ç¡¬ç›˜ç¼“å­˜æ—¶ï¼Œå¹¶æœªå¯¹å¯¹è±¡çš„å¤§å°åšæ£€æŸ¥ã€‚æˆ‘çš„çŒœæƒ³æ˜¯ä¸€æ–¹é¢æ˜¯å¯ä»¥æé«˜ç¼“å­˜çš„å‘½ä¸­ç‡ï¼Œå¦ä¸€æ–¹é¢æ˜¯æœ‰å…¶ä»–æ›´å¥½çš„æ—¶æœºæ¥æ ¸æŸ¥ç¼“å­˜å¯¹è±¡çš„å¤§å°ï¼Œå¹¶æ¸…é™¤è¿‡å¤§çš„ç¼“å­˜å¯¹è±¡ã€‚</p>
<p>å¦‚æœ app è¿›å…¥äº† <code>UIApplication.State.background</code> çŠ¶æ€ï¼ŒKingfisher å°±ä¼šå¼€å§‹æ¸…ç†è¿‡æœŸçš„å¯¹è±¡å’Œè¿‡å¤§çš„ç¼“å­˜å¯¹è±¡ã€‚</p>
<p>æ¸…ç†è¿‡æœŸå¯¹è±¡çš„åšæ³•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">removeExpiredValues</span><span class="params">(referenceDate: Date)</span></span> <span class="keyword">throws</span> -&gt; [<span class="type">URL</span>] &#123;</span><br><span class="line">    <span class="keyword">let</span> propertyKeys: [<span class="type">URLResourceKey</span>] = [</span><br><span class="line">        .isDirectoryKey,</span><br><span class="line">        .contentModificationDateKey</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> urls = <span class="keyword">try</span> allFileURLs(<span class="keyword">for</span>: propertyKeys)</span><br><span class="line">    <span class="keyword">let</span> keys = <span class="type">Set</span>(propertyKeys)</span><br><span class="line">    <span class="keyword">let</span> expiredFiles = urls.<span class="built_in">filter</span> &#123; fileURL <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> meta = <span class="keyword">try</span> <span class="type">FileMeta</span>(fileURL: fileURL, resourceKeys: keys)</span><br><span class="line">            <span class="keyword">if</span> meta.isDirectory &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> meta.expired(referenceDate: referenceDate)</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> expiredFiles.forEach &#123; url <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">try</span> removeFile(at: url)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> expiredFiles</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>æ¸…ç†è¿‡å¤§å¯¹è±¡çš„åšæ³•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">removeSizeExceededValues</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; [<span class="type">URL</span>] &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> config.sizeLimit == <span class="number">0</span> &#123; <span class="keyword">return</span> [] &#125; <span class="comment">// 0 æ„å‘³ç€æ— å¤§å°é™åˆ¶ã€‚</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> size = <span class="keyword">try</span> totalSize()</span><br><span class="line">    <span class="keyword">if</span> size &lt; config.sizeLimit &#123; <span class="keyword">return</span> [] &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> propertyKeys: [<span class="type">URLResourceKey</span>] = [</span><br><span class="line">        .isDirectoryKey,</span><br><span class="line">        .creationDateKey,</span><br><span class="line">        .fileSizeKey</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">let</span> keys = <span class="type">Set</span>(propertyKeys)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> urls = <span class="keyword">try</span> allFileURLs(<span class="keyword">for</span>: propertyKeys)</span><br><span class="line">    <span class="keyword">var</span> pendings: [<span class="type">FileMeta</span>] = urls.compactMap &#123; fileURL <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> meta = <span class="keyword">try</span>? <span class="type">FileMeta</span>(fileURL: fileURL, resourceKeys: keys) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> meta</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»¥ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´ä»å¤§åˆ°å°æ’åºï¼Œæœ€è¿‘è®¿é—®çš„å¯¹è±¡æ’åœ¨æœ€å‰ã€‚</span></span><br><span class="line">    pendings.<span class="built_in">sort</span>(by: <span class="type">FileMeta</span>.lastAccessDate)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> removed: [<span class="type">URL</span>] = []</span><br><span class="line">    <span class="keyword">let</span> target = config.sizeLimit / <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> size &gt; target, <span class="keyword">let</span> meta = pendings.popLast() &#123;</span><br><span class="line">        size -= <span class="type">UInt</span>(meta.fileSize)</span><br><span class="line">        <span class="keyword">try</span> removeFile(at: meta.url)</span><br><span class="line">        removed.append(meta.url)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> removed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ã€Œæ¸…ç†è¿‡å¤§å¯¹è±¡ã€è¿™ä¸ªè¯´æ³•å…¶å®æœ‰äº›æ¨¡ç³Šï¼Œæ›´å‡†ç¡®åœ°è¯´æ˜æ˜¯ï¼šå¦‚æœå½“å‰ç¡¬ç›˜ç¼“å­˜çš„å®¹é‡å¤§äº <code>sizeLimit</code>ï¼Œåˆ™æ ¹æ®å¯¹è±¡çš„ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´è¿›è¡Œæ’åºï¼Œæœ€è¿‘è®¿é—®çš„å¯¹è±¡æ’åœ¨å‰é¢ã€‚Kingfisher çš„åšæ³•æ˜¯ï¼šä»æœ€ä¸ç»å¸¸è®¿é—®çš„å¯¹è±¡å¼€å§‹åˆ é™¤ï¼Œç›´åˆ°å½“å‰å­˜å‚¨çš„å¯¹è±¡çš„æ€»å¤§å°ç¼©å‡è‡³ä¸€åŠåŠå…¶ä»¥ä¸‹ï¼Œæ‰åœæ­¢åˆ é™¤ã€‚è¿™æ˜¯ç»å…¸çš„ LRU ç¼“å­˜æ·˜æ±°ç®—æ³•ã€‚</p>
<h2 id="å‡ºé”™å¤„ç†"><a href="#å‡ºé”™å¤„ç†" class="headerlink" title="å‡ºé”™å¤„ç†"></a>å‡ºé”™å¤„ç†</h2><p>Kingfisher æŠŠè‡ªèº«æ¨¡å—å†…çš„é”™è¯¯ç»†åˆ†ä¸º 5 ç±»ï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Represents the error reason during networking request phase.</span></span><br><span class="line"><span class="keyword">case</span> requestError(reason: <span class="type">RequestErrorReason</span>)</span><br><span class="line"><span class="comment">/// Represents the error reason during networking response phase.</span></span><br><span class="line"><span class="keyword">case</span> responseError(reason: <span class="type">ResponseErrorReason</span>)</span><br><span class="line"><span class="comment">/// Represents the error reason during Kingfisher caching system.</span></span><br><span class="line"><span class="keyword">case</span> cacheError(reason: <span class="type">CacheErrorReason</span>)</span><br><span class="line"><span class="comment">/// Represents the error reason during image processing phase.</span></span><br><span class="line"><span class="keyword">case</span> processorError(reason: <span class="type">ProcessorErrorReason</span>)</span><br><span class="line"><span class="comment">/// Represents the error reason during image setting in a view related class.</span></span><br><span class="line"><span class="keyword">case</span> imageSettingError(reason: <span class="type">ImageSettingErrorReason</span>)</span><br></pre></td></tr></table></figure>
<p>æ¯ç±»é”™è¯¯è¿˜ä¼šæºå¸¦å¯¹åº”å‡ºé”™åŸå› ã€‚ä»é”™è¯¯çš„åˆ†ç±»ï¼Œå¯ä»¥å¤§è‡´çœ‹å‡º Kingfisher åˆ†ä¸ºå›¾ç‰‡ä¸‹è½½æ¨¡å—ã€å›¾ç‰‡ç¼“å­˜æ¨¡å—ã€å›¾ç‰‡å¤„ç†æ¨¡å—ç­‰æ¨¡å—ã€‚</p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>åœ¨é˜…è¯» Kingfisher ç¼“å­˜ç³»ç»Ÿç›¸å…³ä»£ç æ—¶ï¼Œæˆ‘è¿˜å‘ç°äº†å…¶ä»–å€¼å¾—å­¦ä¹ çš„ä»£ç ï¼Œä¸€å¹¶è®°å½•ã€‚</p>
<h3 id="ç½‘ç»œè¯·æ±‚é‡è¯•æœºåˆ¶"><a href="#ç½‘ç»œè¯·æ±‚é‡è¯•æœºåˆ¶" class="headerlink" title="ç½‘ç»œè¯·æ±‚é‡è¯•æœºåˆ¶"></a>ç½‘ç»œè¯·æ±‚é‡è¯•æœºåˆ¶</h3><p><img src="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_02.png" alt="kf_02.001"><br>Kingfisher è®¾è®¡ä¸€ä¸ª <code>RetryStrategy</code>åè®®ï¼Œç”±éµå¾ªè¯¥åè®®çš„å¯¹è±¡æ¥ä½œå‡ºå†³å®šï¼ˆ<code>RetryDecision</code>ï¼‰ã€‚<code>RetryDecision</code> æœ‰ä¸¤ç§ï¼šç»§ç»­é‡è¯•å’Œåœæ­¢é‡è¯•ã€‚</p>
<p>éµå¾ª<code>RetryStrategy</code>åè®®çš„å¯¹è±¡å†…éƒ¨è®¾è®¡äº†ä¸‰ç§é‡è¯•æ¨¡å¼ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">DelayRetryStrategy</span>: <span class="title">RetryStrategy</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Interval</span> </span>&#123;</span><br><span class="line">        <span class="keyword">case</span> seconds(<span class="type">TimeInterval</span>) <span class="comment">// æŒ‡å®š n ç§’åé‡è¯•</span></span><br><span class="line">        <span class="keyword">case</span> accumulated(<span class="type">TimeInterval</span>) <span class="comment">// æŒ‡å®š n ç§’ä»¥ç´¯åŠ çš„æ–¹å¼é‡è¯•ï¼Œä¾‹å¦‚ç¬¬ä¸€æ¬¡ä¸º 3s åé‡è¯•ï¼Œç¬¬äºŒæ¬¡å°±æ˜¯ 6s åé‡è¯•ï¼Œä»¥æ­¤ç±»æ¨ã€‚</span></span><br><span class="line">        <span class="keyword">case</span> custom(block: (<span class="number">_</span> retriedCount: <span class="type">Int</span>) -&gt; <span class="type">TimeInterval</span>) <span class="comment">// å‘Šè¯‰ä½ å·²ç»é‡è¯•çš„æ¬¡æ•°ï¼Œè‡ªè¡Œå†³å®šå‡ ç§’åè¿›è¡Œé‡è¯•</span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">timeInterval</span><span class="params">(<span class="keyword">for</span> retriedCount: Int)</span></span> -&gt; <span class="type">TimeInterval</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> retryAfter: <span class="type">TimeInterval</span></span><br><span class="line">            <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">                <span class="keyword">case</span> .seconds(<span class="keyword">let</span> interval):</span><br><span class="line">                retryAfter = interval</span><br><span class="line">                <span class="keyword">case</span> .accumulated(<span class="keyword">let</span> interval):</span><br><span class="line">                retryAfter = <span class="type">Double</span>(retriedCount + <span class="number">1</span>) * interval</span><br><span class="line">                <span class="keyword">case</span> .custom(<span class="keyword">let</span> block):</span><br><span class="line">                retryAfter = block(retriedCount)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> retryAfter</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>å…¶æ ¸å¿ƒæ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">retry</span><span class="params">(context: RetryContext, retryHandler: @escaping <span class="params">(RetryDecision)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="comment">// è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œåœæ­¢é‡è¯•</span></span><br><span class="line">    <span class="keyword">guard</span> context.retriedCount &lt; maxRetryCount <span class="keyword">else</span> &#123;</span><br><span class="line">        retryHandler(.stop)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å½“å‡ºé”™åŸå› æ˜¯ç”¨æˆ·å–æ¶ˆè¯¥ä»»åŠ¡æ—¶ï¼Œä¸è¿›è¡Œé‡è¯•</span></span><br><span class="line">    <span class="keyword">guard</span> !context.error.isTaskCancelled <span class="keyword">else</span> &#123;</span><br><span class="line">        retryHandler(.stop)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»…åœ¨ç½‘ç»œè¯·æ±‚å“åº”å‡ºé”™æ—¶ï¼Œè¿›è¡Œé‡è¯•</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">case</span> <span class="type">KingfisherError</span>.responseError = context.error <span class="keyword">else</span> &#123;</span><br><span class="line">        retryHandler(.stop)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®å½“å‰æ‰€ä½¿ç”¨çš„é‡è¯•ç­–ç•¥ï¼Œç»“åˆå½“å‰å·²é‡è¯•æ¬¡æ•°ï¼Œè®¡ç®—å‡º interval ç§’åè¿›è¡Œé‡è¯•</span></span><br><span class="line">    <span class="keyword">let</span> interval = retryInterval.timeInterval(<span class="keyword">for</span>: context.retriedCount)</span><br><span class="line">    <span class="keyword">if</span> interval == <span class="number">0</span> &#123; <span class="comment">// ç«‹å³è¿›è¡Œé‡è¯•</span></span><br><span class="line">        retryHandler(.retry(userInfo: <span class="literal">nil</span>))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å»¶è¿Ÿ interval ç§’åï¼Œæäº¤é‡è¯•ä»»åŠ¡ã€‚</span></span><br><span class="line">        <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: .now() + interval) &#123;</span><br><span class="line">            retryHandler(.retry(userInfo: <span class="literal">nil</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å§”æ‰˜æ¨¡å¼"><a href="#å§”æ‰˜æ¨¡å¼" class="headerlink" title="å§”æ‰˜æ¨¡å¼"></a>å§”æ‰˜æ¨¡å¼</h3><p>iOS å¼€å‘è€…æœ€ç†Ÿæ‚‰çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€å°±æ˜¯ <code>Delegate</code>ï¼Œå¸¸è§äº <code>UITableViewDelegate</code> ç­‰ã€‚<br>å¹³æ—¶è‡ªå®šä¹‰çš„ç±»æœ‰æ—¶ä¹Ÿéœ€è¦æŠŠæŸä¸ªæ–¹æ³•çš„å®ç°å§”æ‰˜ç»™å¦ä¸€ä¸ªç±»å»å®ç°ã€‚<br>ä¾‹å¦‚ï¼Œ<code>Task</code> çš„ <code>finish(taskID: String)</code> æ–¹æ³•éœ€è¦äº¤ç»™å¤–éƒ¨å»å®ç°ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> onFinished: ((<span class="type">String</span>) -&gt; <span class="type">String?</span>)?</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">finish</span><span class="params">(taskID: String)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> string = onFinished?(taskID)</span><br><span class="line">        <span class="built_in">print</span>(<span class="type">String</span>(describing: string))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KFViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> subtaskAmount = <span class="number">3</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">let</span> task = <span class="type">Task</span>()</span><br><span class="line">        task.onFinished = &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] taskID <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> = <span class="keyword">self</span> <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> string = <span class="string">"Task \(taskID) is finished, the number of subtasks is \(self.subtaskAmount)"</span></span><br><span class="line">            <span class="keyword">return</span> string</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¾“å‡ºï¼šOptional("Task 123 is finished, the number of subtasks is 3")</span></span><br><span class="line">        task.finish(taskID: <span class="string">"123"</span>)</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·çš„å†™æ³•æ˜¯å¯è¡Œçš„ï¼Œä½†æ¯æ¬¡å¿…é¡»è®°å¾—åœ¨ <code>onFinished</code> é—­åŒ…ä¸­å¼±å¼•ç”¨ <code>self</code> ä»¥å…å‡ºç°å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p>
<p>Kingfisher ä¸­æœ‰è¿™æ ·ä¸€ä¸ªå¥½ç”¨çš„å·¥å…·ç±»ï¼š<code>class Delegate&lt;Input, Output&gt;</code>ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Delegate</span>&lt;<span class="title">Input</span>, <span class="title">Output</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> block: ((<span class="type">Input</span>) -&gt; <span class="type">Output?</span>)?</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">delegate</span>&lt;T: AnyObject&gt;<span class="params">(on target: T, block: <span class="params">(<span class="params">(T, Input)</span></span></span></span> -&gt; <span class="type">Output</span>)?) &#123;</span><br><span class="line">        <span class="keyword">self</span>.block = &#123; [<span class="keyword">weak</span> target] input <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> target = target <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">            <span class="keyword">return</span> block?(target, input)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">call</span><span class="params">(<span class="number">_</span> input: Input)</span></span> -&gt; <span class="type">Output?</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> block?(input)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">callAsFunction</span><span class="params">(<span class="number">_</span> input: Input)</span></span> -&gt; <span class="type">Output?</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> call(input)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>å€ŸåŠ©è¿™ä¸ªå·¥å…·ç±»ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¼˜åŒ–åçš„ç‰ˆæœ¬ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> onFinished = <span class="type">Delegate</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">finish</span><span class="params">(<span class="number">_</span> taskID: String)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> string = onFinished.call(taskID)</span><br><span class="line">        <span class="built_in">print</span>(<span class="type">String</span>(describing: string))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KFViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> subtaskAmount = <span class="number">3</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> task = <span class="type">Task</span>()</span><br><span class="line">        task.onFinished.delegate(on: <span class="keyword">self</span>) &#123; (<span class="keyword">self</span>, taskID) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> string = <span class="string">"Task \(taskID) is finished, the amount of its subtask is \(self.subtaskAmount)"</span></span><br><span class="line">            <span class="keyword">return</span> string</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        task.finish(<span class="string">"123"</span>)</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢ç¬¬äºŒä¸ª <code>self</code> å·²æ˜¯å¼±å¼•ç”¨åçš„ç‰ˆæœ¬ï¼Œæ— éœ€æ¯æ¬¡å¾—åŠ  <code>weak</code> å…³é”®å­—äº†ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">task.onFinished.delegate(on: <span class="keyword">self</span>) &#123; (<span class="keyword">self</span>, taskID) <span class="keyword">in</span></span><br></pre></td></tr></table></figure>
<p>å†è€…ï¼ŒæŠŠåŒ¿åå‡½æ•°ï¼ˆClosureï¼‰åŒ…è£…æˆä¸€ä¸ª <code>Delegate</code> å¯¹è±¡ä½¿ç”¨ä½¿å¾—ä»£ç æ›´åŠ æ¸…æ™°ã€‚</p>
<h4 id="æé—®-1ï¼šä¸ºå•¥-onFinished-call-taskID-è¿”å›çš„æ˜¯å¯é€‰ç±»å‹-Stringï¼Ÿ"><a href="#æé—®-1ï¼šä¸ºå•¥-onFinished-call-taskID-è¿”å›çš„æ˜¯å¯é€‰ç±»å‹-Stringï¼Ÿ" class="headerlink" title="æé—® 1ï¼šä¸ºå•¥ onFinished.call(taskID) è¿”å›çš„æ˜¯å¯é€‰ç±»å‹ Stringï¼Ÿ"></a>æé—® 1ï¼šä¸ºå•¥ onFinished.call(taskID) è¿”å›çš„æ˜¯å¯é€‰ç±»å‹ Stringï¼Ÿ</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œçš„èŒƒå‹çº¦æŸæ˜æ˜æ˜¯ String ç±»å‹</span></span><br><span class="line"><span class="keyword">var</span> onFinished = <span class="type">Delegate</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt;()</span><br></pre></td></tr></table></figure>
<p>å› ä¸º <code>Delegate</code> å†…éƒ¨å®ç°æ˜¯å¼±å¼•ç”¨ <code>self</code>ï¼Œæ‰€ä»¥ <code>self</code> å¤„äºä¸€ç§å¯èƒ½æœ‰å¯èƒ½æ²¡æœ‰çš„çŠ¶æ€ï¼Œè¿™å°±å¯¼è‡´è¿”å›å€¼çš„ç±»å‹å‡æ˜¯å¯é€‰ç±»å‹çš„äº†ã€‚</p>
<h4 id="æé—®-2-å¦‚æœæŠŠ-Output-èŒƒå‹çº¦æŸä¸ºå¯é€‰ç±»å‹ï¼Œé‚£è¿”å›å€¼ç±»å‹ä¸å°±æ˜¯å¯é€‰çš„å¯é€‰ç±»å‹ï¼ˆ-ï¼‰å—ï¼Ÿ"><a href="#æé—®-2-å¦‚æœæŠŠ-Output-èŒƒå‹çº¦æŸä¸ºå¯é€‰ç±»å‹ï¼Œé‚£è¿”å›å€¼ç±»å‹ä¸å°±æ˜¯å¯é€‰çš„å¯é€‰ç±»å‹ï¼ˆ-ï¼‰å—ï¼Ÿ" class="headerlink" title="æé—® 2: å¦‚æœæŠŠ Output èŒƒå‹çº¦æŸä¸ºå¯é€‰ç±»å‹ï¼Œé‚£è¿”å›å€¼ç±»å‹ä¸å°±æ˜¯å¯é€‰çš„å¯é€‰ç±»å‹ï¼ˆ??ï¼‰å—ï¼Ÿ"></a>æé—® 2: å¦‚æœæŠŠ Output èŒƒå‹çº¦æŸä¸ºå¯é€‰ç±»å‹ï¼Œé‚£è¿”å›å€¼ç±»å‹ä¸å°±æ˜¯å¯é€‰çš„å¯é€‰ç±»å‹ï¼ˆ??ï¼‰å—ï¼Ÿ</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Delegate</span>&lt;<span class="title">Input</span>, <span class="title">Output</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> block: ((<span class="type">Input</span>) -&gt; <span class="type">Output?</span>)?</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>Kingfisher å·²å¯¹è¿™ç§æƒ…å†µåšäº†å¤„ç†ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Delegate</span> <span class="title">where</span> <span class="title">Output</span>: <span class="title">OptionalProtocol</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ­¤æ—¶ Output çš„ç±»å‹ä¸ºå¯é€‰ç±»å‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">call</span><span class="params">(<span class="number">_</span> input: Input)</span></span> -&gt; <span class="type">Output</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> result = block?(input) &#123;</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="type">Output</span>._createNil</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">callAsFunction</span><span class="params">(<span class="number">_</span> input: Input)</span></span> -&gt; <span class="type">Output</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> call(input)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">OptionalProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> _createNil: <span class="type">Self</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Optional</span> : <span class="title">OptionalProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> _createNil: <span class="type">Optional</span>&lt;<span class="type">Wrapped</span>&gt; &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ <code>Output</code> ç±»å‹ä¸ºå¯é€‰ç±»å‹æ—¶ï¼Œæ–°å¢ä¸€ä¸ªç›´æ¥è¿”å› <code>Output</code> çš„ <code>call</code> æ–¹æ³•ã€‚</p>
<p>Kingfisher è¿˜ä½¿ç”¨äº† Swift <code>callAsFunction</code> çš„æ–°ç‰¹æ€§ï¼Œè¿™æ„å‘³ç€å¯ä»¥æ— éœ€å†è°ƒç”¨ <code>call</code> æ–¹æ³•ï¼Œå¦‚ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> onFinished = <span class="type">Delegate</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">finish</span><span class="params">(<span class="number">_</span> taskID: String)</span></span> &#123;</span><br><span class="line"><span class="comment">//        let string = onFinished.call(taskID)</span></span><br><span class="line">        <span class="comment">/// åˆ©ç”¨ callAsFunction çš„ç‰¹æ€§</span></span><br><span class="line">        <span class="keyword">let</span> string = onFinished(taskID)</span><br><span class="line">        <span class="built_in">print</span>(<span class="type">String</span>(describing: string))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CacheCallbackCoordinator"><a href="#CacheCallbackCoordinator" class="headerlink" title="CacheCallbackCoordinator"></a>CacheCallbackCoordinator</h3><p>é¡¾åæ€ä¹‰å°±æ˜¯ç¼“å­˜æ¨¡å—å†…çš„å¼‚æ­¥å›è°ƒæ–¹æ³•çš„åè°ƒå™¨ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ˜¯å¦éœ€è¦ç¼“å­˜åŸå§‹å›¾ç‰‡</span></span><br><span class="line"><span class="keyword">let</span> needToCacheOriginalImage = options.cacheOriginalImage &amp;&amp;</span><br><span class="line">options.processor != <span class="type">DefaultImageProcessor</span>.<span class="keyword">default</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> coordinator = <span class="type">CacheCallbackCoordinator</span>(</span><br><span class="line">    shouldWaitForCache: options.waitForCache, shouldCacheOriginal: needToCacheOriginalImage)</span><br><span class="line"><span class="keyword">let</span> result = <span class="type">RetrieveImageResult</span>(</span><br><span class="line">    image: options.imageModifier?.modify(value.image) ?? value.image,</span><br><span class="line">    cacheType: .<span class="keyword">none</span>,</span><br><span class="line">    source: source,</span><br><span class="line">    originalSource: context.originalSource</span><br><span class="line">)</span><br><span class="line"><span class="comment">// Add image to cache.</span></span><br><span class="line"><span class="keyword">let</span> targetCache = options.targetCache ?? <span class="keyword">self</span>.cache</span><br><span class="line">targetCache.store(</span><br><span class="line">    value.image,</span><br><span class="line">    original: value.originalData,</span><br><span class="line">    forKey: source.cacheKey,</span><br><span class="line">    options: options,</span><br><span class="line">    toDisk: !options.cacheMemoryOnly)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">    coordinator.apply(.cachingImage) &#123;</span><br><span class="line">        completionHandler?(.success(result))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> needToCacheOriginalImage &#123;</span><br><span class="line">    <span class="keyword">let</span> originalCache = options.originalCache ?? targetCache</span><br><span class="line">    originalCache.storeToDisk(</span><br><span class="line">        value.originalData,</span><br><span class="line">        forKey: source.cacheKey,</span><br><span class="line">        processorIdentifier: <span class="type">DefaultImageProcessor</span>.<span class="keyword">default</span>.identifier,</span><br><span class="line">        expiration: options.diskCacheExpiration)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">        coordinator.apply(.cachingOriginalImage) &#123;</span><br><span class="line">            completionHandler?(.success(result))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">coordinator.apply(.cacheInitiated) &#123;</span><br><span class="line">    completionHandler?(.success(result))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ‰ä¸¤ä¸ªå¸ƒå°”å€¼åœ¨æ§åˆ¶ <code>completionHandler?(.success(result))</code> æ‰§è¡Œçš„æ—¶æœºï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li>æ˜¯å¦éœ€è¦ç¼“å­˜åŸå§‹å›¾ç‰‡ï¼ˆneedToCacheOriginalImageï¼‰</li>
<li>æ˜¯å¦ç­‰å¾…ç¼“å­˜è¿‡ç¨‹ç»“æŸï¼ˆshouldWaitForCacheï¼‰</li>
</ol>
<p>åœ¨è¿™ä¸¤ä¸ªå˜é‡çš„æ’åˆ—ç»„åˆä¸‹ï¼ŒKingfisher éœ€è¦ç¡®ä¿è¯¥å›è°ƒæ‰§è¡Œçš„æ¬¡æ•°<strong>æœ‰ä¸”åªæœ‰ä¸€æ¬¡ï¼</strong></p>
<p>å› æ­¤ï¼Œ<code>CacheCallbackCoordinator</code> å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒ…å«å››ç§çŠ¶æ€çš„æšä¸¾ <code>State</code>ã€å¯¼è‡´çŠ¶æ€å‘ç”Ÿè½¬ç§»çš„ä¸‰ç§ <code>Action</code>ï¼Œä»¥åŠæè¿°çŠ¶æ€æ˜¯å¦‚ä½•è½¬ç§»çš„ <code>apply</code> æ–¹æ³•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> idle</span><br><span class="line">    <span class="keyword">case</span> imageCached</span><br><span class="line">    <span class="keyword">case</span> originalImageCached</span><br><span class="line">    <span class="keyword">case</span> done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Action</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> cacheInitiated</span><br><span class="line">    <span class="keyword">case</span> cachingImage</span><br><span class="line">    <span class="keyword">case</span> cachingOriginalImage</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">apply</span><span class="params">(<span class="number">_</span> action: Action, trigger: <span class="params">()</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (state, action) &#123;</span><br><span class="line">        <span class="keyword">case</span> (.done, <span class="number">_</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From .idle</span></span><br><span class="line">        <span class="keyword">case</span> (.idle, .cacheInitiated):</span><br><span class="line">        <span class="keyword">if</span> !shouldWaitForCache &#123;</span><br><span class="line">            state = .done</span><br><span class="line">            trigger()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> (.idle, .cachingImage):</span><br><span class="line">        <span class="keyword">if</span> shouldCacheOriginal &#123;</span><br><span class="line">            state = .imageCached</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            state = .done</span><br><span class="line">            trigger()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> (.idle, .cachingOriginalImage):</span><br><span class="line">        state = .originalImageCached</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From .imageCached</span></span><br><span class="line">        <span class="keyword">case</span> (.imageCached, .cachingOriginalImage):</span><br><span class="line">        state = .done</span><br><span class="line">        trigger()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From .originalImageCached</span></span><br><span class="line">        <span class="keyword">case</span> (.originalImageCached, .cachingImage):</span><br><span class="line">        state = .done</span><br><span class="line">        trigger()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">assertionFailure</span>(<span class="string">"This case should not happen in CacheCallbackCoordinator: \(state) - \(action)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰äº†è¿™äº›ï¼Œä¾¿å¯ä»¥ç”»å‡ºä¸€ä¸ªæœ‰é™çŠ¶æ€æœºçš„çŠ¶æ€è½¬ç§»å›¾ï¼š<img src="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_03.png" alt="CacheCallbackCoordinator çŠ¶æ€æœº"><br>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼šåœ¨ä» <code>idle</code> çŠ¶æ€åˆ° <code>done</code> çŠ¶æ€çš„ä»»æ„ä¸€æ¡è·¯çº¿ä¸Šï¼Œ<code>trigger</code> æ–¹æ³•çš„æ‰§è¡Œæ¬¡æ•°<strong>æœ‰ä¸”åªæœ‰ä¸€æ¬¡</strong>ï¼è¿™æ ·è®¾è®¡çš„ä»£ç æ¸…æ™°ï¼Œä¹Ÿå®¹æ˜“æµ‹è¯•ï¼Œæ˜¯å¾ˆå€¼å¾—å­¦ä¹ çš„æ¡ˆä¾‹äº†ï¼</p>
<h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>è¯» Kingfisher æºç è¦åˆ†äº«çš„ç¬¬ä¸€éƒ¨åˆ†å°±åˆ°æ­¤ç»“æŸäº†ï¼Œè¿˜æœ‰å›¾ç‰‡ä¸‹è½½æµç¨‹ã€å›¾ç‰‡å¤„ç†æµç¨‹ã€å¯¹å¤šå¹³å°çš„æ”¯æŒï¼ˆKingfisher è¿˜æ”¯æŒ watchOSã€tvOS å’Œ macOSï¼‰ç­‰ã€‚</p>
<p>è¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ¯”è¾ƒè®¤çœŸåœ°èŠ±å¤§æ®µæ—¶é—´ä»”ç»†è¯»å¼€æºä»£ç ï¼Œæ”¶è·é¢‡ä¸°ã€‚</p>
<p>å°±è¿™æ ·æ…¢æ…¢è¿›æ­¥å§ï¼</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kingfisher/" rel="tag"># Kingfisher</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/08/09/WWDC%2021%2010267%20%E4%B8%80%E7%AA%A5%20Xcode%20Cloud/" rel="prev" title="WWDC21 10267 ä¸€çª¥ Xcode Cloud">
      <i class="fa fa-chevron-left"></i> WWDC21 10267 ä¸€çª¥ Xcode Cloud
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/03/30/%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%20iOS%20App%20CI%20%E7%B3%BB%E7%BB%9F/" rel="next" title="æ‰“é€ ä¸€ä¸ªç®€å•çš„ iOS App CI ç³»ç»Ÿ">
      æ‰“é€ ä¸€ä¸ªç®€å•çš„ iOS App CI ç³»ç»Ÿ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å†…å­˜ç¼“å­˜"><span class="nav-number">1.</span> <span class="nav-text">å†…å­˜ç¼“å­˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç¡¬ç›˜ç¼“å­˜"><span class="nav-number">2.</span> <span class="nav-text">ç¡¬ç›˜ç¼“å­˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç¼“å­˜è¿‡æœŸç­–ç•¥"><span class="nav-number">3.</span> <span class="nav-text">ç¼“å­˜è¿‡æœŸç­–ç•¥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç¼“å­˜ç»­æœŸç­–ç•¥"><span class="nav-number">4.</span> <span class="nav-text">ç¼“å­˜ç»­æœŸç­–ç•¥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç¼“å­˜æ¸…é™¤ç­–ç•¥"><span class="nav-number">5.</span> <span class="nav-text">ç¼“å­˜æ¸…é™¤ç­–ç•¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å†…å­˜ç¼“å­˜æ¸…é™¤ç­–ç•¥"><span class="nav-number">5.1.</span> <span class="nav-text">å†…å­˜ç¼“å­˜æ¸…é™¤ç­–ç•¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¡¬ç›˜ç¼“å­˜æ¸…é™¤ç­–ç•¥"><span class="nav-number">5.2.</span> <span class="nav-text">ç¡¬ç›˜ç¼“å­˜æ¸…é™¤ç­–ç•¥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‡ºé”™å¤„ç†"><span class="nav-number">6.</span> <span class="nav-text">å‡ºé”™å¤„ç†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å…¶ä»–"><span class="nav-number">7.</span> <span class="nav-text">å…¶ä»–</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ç½‘ç»œè¯·æ±‚é‡è¯•æœºåˆ¶"><span class="nav-number">7.1.</span> <span class="nav-text">ç½‘ç»œè¯·æ±‚é‡è¯•æœºåˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å§”æ‰˜æ¨¡å¼"><span class="nav-number">7.2.</span> <span class="nav-text">å§”æ‰˜æ¨¡å¼</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#æé—®-1ï¼šä¸ºå•¥-onFinished-call-taskID-è¿”å›çš„æ˜¯å¯é€‰ç±»å‹-Stringï¼Ÿ"><span class="nav-number">7.2.1.</span> <span class="nav-text">æé—® 1ï¼šä¸ºå•¥ onFinished.call(taskID) è¿”å›çš„æ˜¯å¯é€‰ç±»å‹ Stringï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æé—®-2-å¦‚æœæŠŠ-Output-èŒƒå‹çº¦æŸä¸ºå¯é€‰ç±»å‹ï¼Œé‚£è¿”å›å€¼ç±»å‹ä¸å°±æ˜¯å¯é€‰çš„å¯é€‰ç±»å‹ï¼ˆ-ï¼‰å—ï¼Ÿ"><span class="nav-number">7.2.2.</span> <span class="nav-text">æé—® 2: å¦‚æœæŠŠ Output èŒƒå‹çº¦æŸä¸ºå¯é€‰ç±»å‹ï¼Œé‚£è¿”å›å€¼ç±»å‹ä¸å°±æ˜¯å¯é€‰çš„å¯é€‰ç±»å‹ï¼ˆ??ï¼‰å—ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CacheCallbackCoordinator"><span class="nav-number">7.3.</span> <span class="nav-text">CacheCallbackCoordinator</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç»“è¯­"><span class="nav-number">8.</span> <span class="nav-text">ç»“è¯­</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Sunset Wan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/SunsetWan" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;SunsetWan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sunset Wan</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
