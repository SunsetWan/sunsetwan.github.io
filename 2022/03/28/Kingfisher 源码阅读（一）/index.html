<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"sunsetwan.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.26.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"default"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="æœ€è¿‘æƒ³äº†è§£å¦‚ä½•è®¾è®¡ä¸€ä¸ªç®€å•çš„ç¼“å­˜ç³»ç»Ÿï¼Œäºæ˜¯æ‰¾äº† Kingfisher 7.1.2 ç‰ˆæœ¬çš„æºä»£ç è¯»ä¸€è¯»ï¼Œæœ‰äº›æ”¶è·ï¼Œè®°å½•äºæ­¤ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Kingfisher æºç é˜…è¯»ï¼ˆä¸€ï¼‰">
<meta property="og:url" content="https://sunsetwan.github.io/2022/03/28/Kingfisher%20%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/index.html">
<meta property="og:site_name" content="æ—¥è½å¤§é“">
<meta property="og:description" content="æœ€è¿‘æƒ³äº†è§£å¦‚ä½•è®¾è®¡ä¸€ä¸ªç®€å•çš„ç¼“å­˜ç³»ç»Ÿï¼Œäºæ˜¯æ‰¾äº† Kingfisher 7.1.2 ç‰ˆæœ¬çš„æºä»£ç è¯»ä¸€è¯»ï¼Œæœ‰äº›æ”¶è·ï¼Œè®°å½•äºæ­¤ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_01.jpg">
<meta property="og:image" content="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_02.png">
<meta property="og:image" content="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_03.png">
<meta property="article:published_time" content="2022-03-28T09:41:00.000Z">
<meta property="article:modified_time" content="2025-12-02T16:13:36.957Z">
<meta property="article:author" content="Sunset Wan">
<meta property="article:tag" content="Kingfisher">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_01.jpg">


<link rel="canonical" href="https://sunsetwan.github.io/2022/03/28/Kingfisher%20%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://sunsetwan.github.io/2022/03/28/Kingfisher%20%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/","path":"2022/03/28/Kingfisher æºç é˜…è¯»ï¼ˆä¸€ï¼‰/","title":"Kingfisher æºç é˜…è¯»ï¼ˆä¸€ï¼‰"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Kingfisher æºç é˜…è¯»ï¼ˆä¸€ï¼‰ | æ—¥è½å¤§é“</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">æ—¥è½å¤§é“</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98"><span class="nav-number">1.</span> <span class="nav-text">å†…å­˜ç¼“å­˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AC%E7%9B%98%E7%BC%93%E5%AD%98"><span class="nav-number">2.</span> <span class="nav-text">ç¡¬ç›˜ç¼“å­˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5"><span class="nav-number">3.</span> <span class="nav-text">ç¼“å­˜è¿‡æœŸç­–ç•¥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%BB%AD%E6%9C%9F%E7%AD%96%E7%95%A5"><span class="nav-number">4.</span> <span class="nav-text">ç¼“å­˜ç»­æœŸç­–ç•¥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E6%B8%85%E9%99%A4%E7%AD%96%E7%95%A5"><span class="nav-number">5.</span> <span class="nav-text">ç¼“å­˜æ¸…é™¤ç­–ç•¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98%E6%B8%85%E9%99%A4%E7%AD%96%E7%95%A5"><span class="nav-number">5.1.</span> <span class="nav-text">å†…å­˜ç¼“å­˜æ¸…é™¤ç­–ç•¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AC%E7%9B%98%E7%BC%93%E5%AD%98%E6%B8%85%E9%99%A4%E7%AD%96%E7%95%A5"><span class="nav-number">5.2.</span> <span class="nav-text">ç¡¬ç›˜ç¼“å­˜æ¸…é™¤ç­–ç•¥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BA%E9%94%99%E5%A4%84%E7%90%86"><span class="nav-number">6.</span> <span class="nav-text">å‡ºé”™å¤„ç†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">7.</span> <span class="nav-text">å…¶ä»–</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="nav-number">7.1.</span> <span class="nav-text">ç½‘ç»œè¯·æ±‚é‡è¯•æœºåˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A7%94%E6%89%98%E6%A8%A1%E5%BC%8F"><span class="nav-number">7.2.</span> <span class="nav-text">å§”æ‰˜æ¨¡å¼</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E9%97%AE-1%EF%BC%9A%E4%B8%BA%E5%95%A5-onFinished-call-taskID-%E8%BF%94%E5%9B%9E%E7%9A%84%E6%98%AF%E5%8F%AF%E9%80%89%E7%B1%BB%E5%9E%8B-String%EF%BC%9F"><span class="nav-number">7.2.1.</span> <span class="nav-text">æé—® 1ï¼šä¸ºå•¥ onFinished.call(taskID) è¿”å›çš„æ˜¯å¯é€‰ç±»å‹ Stringï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E9%97%AE-2-%E5%A6%82%E6%9E%9C%E6%8A%8A-Output-%E6%B3%9B%E5%9E%8B%E7%BA%A6%E6%9D%9F%E4%B8%BA%E5%8F%AF%E9%80%89%E7%B1%BB%E5%9E%8B%EF%BC%8C%E9%82%A3%E8%BF%94%E5%9B%9E%E5%80%BC%E7%B1%BB%E5%9E%8B%E4%B8%8D%E5%B0%B1%E6%98%AF%E5%8F%AF%E9%80%89%E7%9A%84%E5%8F%AF%E9%80%89%E7%B1%BB%E5%9E%8B%EF%BC%88-%EF%BC%89%E5%90%97%EF%BC%9F"><span class="nav-number">7.2.2.</span> <span class="nav-text">æé—® 2: å¦‚æœæŠŠ Output æ³›å‹çº¦æŸä¸ºå¯é€‰ç±»å‹ï¼Œé‚£è¿”å›å€¼ç±»å‹ä¸å°±æ˜¯å¯é€‰çš„å¯é€‰ç±»å‹ï¼ˆ??ï¼‰å—ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CacheCallbackCoordinator"><span class="nav-number">7.3.</span> <span class="nav-text">CacheCallbackCoordinator</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E8%AF%AD"><span class="nav-number">8.</span> <span class="nav-text">ç»“è¯­</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Sunset Wan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/SunsetWan" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;SunsetWan" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sunsetwan.github.io/2022/03/28/Kingfisher%20%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sunset Wan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ—¥è½å¤§é“">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Kingfisher æºç é˜…è¯»ï¼ˆä¸€ï¼‰ | æ—¥è½å¤§é“">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kingfisher æºç é˜…è¯»ï¼ˆä¸€ï¼‰
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-03-28 09:41:00" itemprop="dateCreated datePublished" datetime="2022-03-28T09:41:00+00:00">2022-03-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-12-02 16:13:36" itemprop="dateModified" datetime="2025-12-02T16:13:36+00:00">2025-12-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>æœ€è¿‘æƒ³äº†è§£å¦‚ä½•è®¾è®¡ä¸€ä¸ªç®€å•çš„ç¼“å­˜ç³»ç»Ÿï¼Œäºæ˜¯æ‰¾äº† Kingfisher 7.1.2 ç‰ˆæœ¬çš„æºä»£ç è¯»ä¸€è¯»ï¼Œæœ‰äº›æ”¶è·ï¼Œè®°å½•äºæ­¤ã€‚<span id="more"></span></p>
<p>ç¼“å­˜ç³»ç»Ÿä¸€èˆ¬å¯åˆ†ä¸ºï¼šå†…å­˜ç¼“å­˜ï¼ˆmemory cacheï¼‰å’Œç¡¬ç›˜ç¼“å­˜ï¼ˆdisk cacheï¼‰ã€‚</p>
<h2 id="å†…å­˜ç¼“å­˜"><a href="#å†…å­˜ç¼“å­˜" class="headerlink" title="å†…å­˜ç¼“å­˜"></a>å†…å­˜ç¼“å­˜</h2><p>å†…å­˜ç¼“å­˜èƒŒåæ”¯æ’‘çš„æ•°æ®ç»“æ„æ˜¯ Foundation æ¡†æ¶ä¸­çš„ <code>NSCache</code>ã€‚<br><code>NSCache</code> æœ‰ä¸¤ä¸ªé™åˆ¶ï¼š<code>countLimit</code> å’Œ <code>totalCostLimit</code>ã€‚å‰è€…æ˜¯è¡¨ç¤ºèƒ½å­˜å‚¨å¤šå°‘ä¸ªå¯¹è±¡ï¼Œåè€…æ˜¯è¡¨ç¤ºç¼“å­˜çš„å®¹é‡æœ‰å¤šå¤§ã€‚ä½†è¿™ä¸¤ä¸ªé™åˆ¶æ˜¯è½¯é™åˆ¶â€”â€”å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œ<code>NSCache</code> ä¸­ä¿å­˜çš„å¯¹è±¡ä¸ä¸€å®šä¼šè¢«åŠæ—¶åœ°ä»å…¶ä¸­ç§»å‡ºã€‚æ ¹æ® <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/nscache?language=objc">å®˜æ–¹æ–‡æ¡£</a>ï¼Œè¶…è¿‡é™åˆ¶ä¹‹åï¼Œå¯¹è±¡çš„ç§»å‡ºæ—¶æœºå–å†³ä¸ <code>NSCache</code> èƒŒåçš„å®ç°ã€‚</p>
<p><img src="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_01.jpg" alt="kf_01"></p>
<p><code>NSCache</code> æ˜¯ä¸ªæ³›å‹ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—å®šä¹‰å¥½ <code>KeyType</code> å’Œ <code>ObjectType</code>ã€‚<br>æ ¹æ®å£°æ˜çš„ç±»å‹çº¦æŸï¼Œ<code>KeyType</code> çš„ç±»å‹å¾—æ˜¯ä¸€ä¸ªç±»ã€‚ä¸€èˆ¬åœ°ï¼Œç±»ä¼¼ key çš„æ•°æ®ç»“æ„ä¼šé‡‡ç”¨ <code>String</code>ã€‚è€Œè¿™é‡Œ <code>KeyType</code> å¾—æ˜¯å¼•ç”¨ç±»å‹è€Œä¸æ˜¯å€¼ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šé€‰æ‹© <code>NSString</code>ã€‚ä½†åœ¨ API è®¾è®¡æ—¶ï¼Œå¯¹å¤–æš´éœ²çš„é‚£ä¸€å±‚ APIï¼Œè¿˜æ˜¯å¯ä»¥ä½¿ç”¨ <code>String</code>ã€‚åˆ°è°ƒç”¨ <code>NSCache</code> çš„ <code>setObject(_:forKey:cost:)</code> æ–¹æ³•æ—¶ï¼Œå†æŠŠ <code>String</code> è½¬ä¸º <code>NSString</code>ã€‚ä¹‹æ‰€ä»¥è¿™æ ·åšï¼Œæ˜¯å› ä¸ºå€¼ç±»å‹æ›´ç¬¦åˆå½“å‰åœºæ™¯çš„éœ€æ±‚ã€‚<br>Kingfisher ä¸­ <code>ObjectType</code> å¯¹åº”çš„æ•°æ®ç»“æ„æ˜¯è¿™ä¹ˆè®¾è®¡çš„ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StorageObject</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> value: <span class="type">T</span> <span class="comment">// å›¾ç‰‡çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">let</span> expiration: <span class="type">StorageExpiration</span> <span class="comment">// è¿‡æœŸç­–ç•¥</span></span><br><span class="line">    <span class="keyword">let</span> key: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private(set)</span> <span class="keyword">var</span> estimatedExpiration: <span class="type">Date</span> <span class="comment">// é¢„è®¡åˆ°æœŸæ—¶é—´</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="keyword">_</span> <span class="params">value</span>: <span class="type">T</span>, <span class="params">key</span>: <span class="type">String</span>, <span class="params">expiration</span>: <span class="type">StorageExpiration</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value <span class="operator">=</span> value</span><br><span class="line">        <span class="keyword">self</span>.key <span class="operator">=</span> key</span><br><span class="line">        <span class="keyword">self</span>.expiration <span class="operator">=</span> expiration</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.estimatedExpiration <span class="operator">=</span> expiration.estimatedExpirationSinceNow</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®å½“å‰ç¼“å­˜å¯¹è±¡çš„ç»­æœŸç­–ç•¥ï¼Œè¿›è¡Œç»­æœŸã€‚</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">extendExpiration</span>(<span class="keyword">_</span> <span class="params">extendingExpiration</span>: <span class="type">ExpirationExtending</span> <span class="operator">=</span> .cacheTime) &#123;</span><br><span class="line">        <span class="keyword">switch</span> extendingExpiration &#123;</span><br><span class="line">            <span class="keyword">case</span> .none:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">case</span> .cacheTime:</span><br><span class="line">            <span class="keyword">self</span>.estimatedExpiration <span class="operator">=</span> expiration.estimatedExpirationSinceNow</span><br><span class="line">            <span class="keyword">case</span> .expirationTime(<span class="keyword">let</span> expirationTime):</span><br><span class="line">            <span class="keyword">self</span>.estimatedExpiration <span class="operator">=</span> expirationTime.estimatedExpirationSinceNow</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> expired: <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> estimatedExpiration.isPast</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç¡¬ç›˜ç¼“å­˜"><a href="#ç¡¬ç›˜ç¼“å­˜" class="headerlink" title="ç¡¬ç›˜ç¼“å­˜"></a>ç¡¬ç›˜ç¼“å­˜</h2><p>æ‰€è°“ç¡¬ç›˜ç¼“å­˜ï¼Œå°±æ˜¯æŠŠç¼“å­˜æ•°æ®å†™å…¥ä¸€ä¸ªæ–‡ä»¶ã€‚å½“å¯¹è±¡å†™å…¥ç¡¬ç›˜ç¼“å­˜æ—¶ï¼Œéœ€è¦çš„æ˜¯å›¾ç‰‡çš„æ•°æ®ï¼Œç¼“å­˜çš„ Key ä»¥åŠè¿‡æœŸç­–ç•¥ï¼ˆStorageExpirationï¼‰ã€‚å†™å…¥æ–‡ä»¶çš„ URL æ˜¯é€šè¿‡ç¼“å­˜çš„ Key è®¡ç®—å¯å¾—ã€‚</p>
<p>Kingfisher åˆ©ç”¨æ“ä½œç³»ç»Ÿä¸­çš„æ–‡ä»¶ç³»ç»Ÿæ¥å¿«æ·åœ°å­˜å‚¨è¯¥ç¼“å­˜å¯¹è±¡çš„ <strong>ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´</strong> å’Œ <strong>é¢„è®¡åˆ°æœŸæ—¶é—´</strong>ã€‚Kingfisher æŠŠå†™å…¥æ–‡ä»¶çš„ <strong>åˆ›å»ºæ—¶é—´</strong> å†™ä¸º <strong>ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´</strong>ï¼ŒæŠŠå†™å…¥æ–‡ä»¶çš„ <strong>ä¿®æ”¹æ—¥æœŸ</strong> å†™ä¸º <strong>é¢„è®¡åˆ°æœŸæ—¶é—´</strong>ï¼Œè¿˜æŒºå·§å¦™çš„ ğŸ¤¯ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> now <span class="operator">=</span> <span class="type">Date</span>()</span><br><span class="line"><span class="keyword">let</span> attributes: [<span class="type">FileAttributeKey</span> : <span class="keyword">Any</span>] <span class="operator">=</span> [</span><br><span class="line">    <span class="comment">// The last access date.</span></span><br><span class="line">    .creationDate: now.fileAttributeDate,</span><br><span class="line">    <span class="comment">// The estimated expiration date.</span></span><br><span class="line">    .modificationDate: expiration.estimatedExpirationSinceNow.fileAttributeDate</span><br><span class="line">]</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> config.fileManager.setAttributes(attributes, ofItemAtPath: fileURL.path)</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">try?</span> config.fileManager.removeItem(at: fileURL)</span><br><span class="line">    <span class="keyword">throw</span> <span class="type">KingfisherError</span>.cacheError(</span><br><span class="line">        reason: .cannotSetCacheFileAttribute(</span><br><span class="line">            filePath: fileURL.path,</span><br><span class="line">            attributes: attributes,</span><br><span class="line">            error: error</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ä»ç¡¬ç›˜ä¸­è®¿é—®ç¼“å­˜æ—¶ï¼ŒKingfisher è®¾è®¡äº† <code>FileMeta</code> æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FileMeta</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> url: <span class="type">URL</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> lastAccessDate: <span class="type">Date</span>?</span><br><span class="line">    <span class="keyword">let</span> estimatedExpirationDate: <span class="type">Date</span>?</span><br><span class="line">    <span class="keyword">let</span> isDirectory: <span class="type">Bool</span></span><br><span class="line">    <span class="keyword">let</span> fileSize: <span class="type">Int</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(</span><br><span class="line">        <span class="params">fileURL</span>: <span class="type">URL</span>,</span><br><span class="line">        <span class="params">lastAccessDate</span>: <span class="type">Date</span>?,</span><br><span class="line">        <span class="params">estimatedExpirationDate</span>: <span class="type">Date</span>?,</span><br><span class="line">        <span class="params">isDirectory</span>: <span class="type">Bool</span>,</span><br><span class="line">        <span class="params">fileSize</span>: <span class="type">Int</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">self</span>.url <span class="operator">=</span> fileURL</span><br><span class="line">        <span class="keyword">self</span>.lastAccessDate <span class="operator">=</span> lastAccessDate</span><br><span class="line">        <span class="keyword">self</span>.estimatedExpirationDate <span class="operator">=</span> estimatedExpirationDate</span><br><span class="line">        <span class="keyword">self</span>.isDirectory <span class="operator">=</span> isDirectory</span><br><span class="line">        <span class="keyword">self</span>.fileSize <span class="operator">=</span> fileSize</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">expired</span>(<span class="params">referenceDate</span>: <span class="type">Date</span>) -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> estimatedExpirationDate<span class="operator">?</span>.isPast(referenceDate: referenceDate) <span class="operator">??</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®å½“å‰ç¼“å­˜å¯¹è±¡çš„ç»­æœŸç­–ç•¥ï¼Œè¿›è¡Œç»­æœŸã€‚</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">extendExpiration</span>(<span class="params">with</span> <span class="params">fileManager</span>: <span class="type">FileManager</span>, <span class="params">extendingExpiration</span>: <span class="type">ExpirationExtending</span>) &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> lastAccessDate <span class="operator">=</span> lastAccessDate,</span><br><span class="line">        <span class="keyword">let</span> lastEstimatedExpiration <span class="operator">=</span> estimatedExpirationDate <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> attributes: [<span class="type">FileAttributeKey</span> : <span class="keyword">Any</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> extendingExpiration &#123;</span><br><span class="line">            <span class="keyword">case</span> .none:</span><br><span class="line">            <span class="comment">// not extending expiration time here</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">case</span> .cacheTime:</span><br><span class="line">            <span class="keyword">let</span> originalExpiration: <span class="type">StorageExpiration</span> <span class="operator">=</span></span><br><span class="line">            .seconds(lastEstimatedExpiration.timeIntervalSince(lastAccessDate))</span><br><span class="line">            attributes <span class="operator">=</span> [</span><br><span class="line">                .creationDate: <span class="type">Date</span>().fileAttributeDate,</span><br><span class="line">                .modificationDate: originalExpiration.estimatedExpirationSinceNow.fileAttributeDate</span><br><span class="line">            ]</span><br><span class="line">            <span class="keyword">case</span> .expirationTime(<span class="keyword">let</span> expirationTime):</span><br><span class="line">            attributes <span class="operator">=</span> [</span><br><span class="line">                .creationDate: <span class="type">Date</span>().fileAttributeDate,</span><br><span class="line">                .modificationDate: expirationTime.estimatedExpirationSinceNow.fileAttributeDate</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try?</span> fileManager.setAttributes(attributes, ofItemAtPath: url.path)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸éš¾çœ‹å‡ºï¼š<code>FileMeta</code> çš„è®¾è®¡æ€è·¯ä¸ <code>StorageObject</code> çš„è®¾è®¡æ€è·¯æœ‰ä¸å°‘ç›¸ä¼¼çš„åœ°æ–¹ã€‚</p>
<h2 id="ç¼“å­˜è¿‡æœŸç­–ç•¥"><a href="#ç¼“å­˜è¿‡æœŸç­–ç•¥" class="headerlink" title="ç¼“å­˜è¿‡æœŸç­–ç•¥"></a>ç¼“å­˜è¿‡æœŸç­–ç•¥</h2><p>Kingfisher æœ‰è®¾è®¡ 5 ç§ç¼“å­˜å¯¹è±¡çš„è¿‡æœŸç­–ç•¥ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">StorageExpiration</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> never <span class="comment">// ç¼“å­˜å¯¹è±¡æ°¸ä¸è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">case</span> seconds(<span class="type">TimeInterval</span>) <span class="comment">// ç¼“å­˜å¯¹è±¡åœ¨å½“å‰æ—¶é—´ç‚¹åçš„ x ç§’è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">case</span> days(<span class="type">Int</span>) <span class="comment">// ç¼“å­˜å¯¹è±¡åœ¨å½“å‰æ—¶é—´ç‚¹åçš„ x å¤©è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">case</span> date(<span class="type">Date</span>) <span class="comment">// ç¼“å­˜å¯¹è±¡åœ¨æŒ‡å®š Date è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">case</span> expired <span class="comment">// ç¼“å­˜å¯¹è±¡å·²è¿‡æœŸ</span></span><br><span class="line">		<span class="operator">...</span></span><br><span class="line">		<span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç¼“å­˜ç»­æœŸç­–ç•¥"><a href="#ç¼“å­˜ç»­æœŸç­–ç•¥" class="headerlink" title="ç¼“å­˜ç»­æœŸç­–ç•¥"></a>ç¼“å­˜ç»­æœŸç­–ç•¥</h2><p>æ ¹æ®ç¨‹åºå±€éƒ¨æ€§çš„åŸç†ï¼Œè¢«è®¿é—®è¿‡çš„ç¼“å­˜å¾ˆæœ‰å¯èƒ½å†è¢«è®¿é—®ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¹Ÿåº”æœ‰ç¼“å­˜ç»­æœŸç­–ç•¥ã€‚<br>Kingfisher æœ‰è®¾è®¡ 3 ç§ç¼“å­˜ç»­æœŸç­–ç•¥ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ExpirationExtending</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> none <span class="comment">// ä¸ç»­æœŸï¼Œåˆ°æœŸæ—¶é—´ä¸å˜</span></span><br><span class="line">    <span class="keyword">case</span> cacheTime <span class="comment">// ä»¥å½“å‰æ—¶é—´ç‚¹ä¸ºåŸºç¡€ç»­æœŸ</span></span><br><span class="line">    <span class="keyword">case</span> expirationTime(<span class="keyword">_</span> expiration: <span class="type">StorageExpiration</span>) <span class="comment">// ä»¥æŒ‡å®šåˆ°æœŸç­–ç•¥ç»­æœŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ— è®ºæ˜¯å†…å­˜ç¼“å­˜è¿˜æ˜¯ç¡¬ç›˜ç¼“å­˜ï¼Œé»˜è®¤çš„ç¼“å­˜ç»­æœŸç­–ç•¥å‡ä¸ºï¼š<code>cacheTime</code>ã€‚</p>
<h2 id="ç¼“å­˜æ¸…é™¤ç­–ç•¥"><a href="#ç¼“å­˜æ¸…é™¤ç­–ç•¥" class="headerlink" title="ç¼“å­˜æ¸…é™¤ç­–ç•¥"></a>ç¼“å­˜æ¸…é™¤ç­–ç•¥</h2><h3 id="å†…å­˜ç¼“å­˜æ¸…é™¤ç­–ç•¥"><a href="#å†…å­˜ç¼“å­˜æ¸…é™¤ç­–ç•¥" class="headerlink" title="å†…å­˜ç¼“å­˜æ¸…é™¤ç­–ç•¥"></a>å†…å­˜ç¼“å­˜æ¸…é™¤ç­–ç•¥</h3><p>å†…å­˜ç¼“å­˜çš„æ¸…é™¤ç­–ç•¥åˆ†ä¸ºä¸¤ç§ï¼š</p>
<ol>
<li>ç³»ç»Ÿæ§åˆ¶ï¼šè¶…è¿‡ <code>NSCache</code> çš„â€œè½¯é™åˆ¶â€ï¼Œç³»ç»Ÿè‡ªåŠ¨æ¸…é™¤ã€‚</li>
<li>è‡ªå·±æ§åˆ¶ï¼šå®šæœŸæ‰«æå·²ç¼“å­˜çš„å¯¹è±¡ï¼Œç§»å‡ºå·²è¿‡æœŸçš„å¯¹è±¡ã€‚</li>
</ol>
<p>å¯¹äºç¼“å­˜ç³»ç»Ÿæ¥è¯´ï¼Œç­–ç•¥ 1 æ˜¯å¯èƒ½æœ‰è´Ÿé¢å½±å“çš„ï¼Œå› ä¸ºç³»ç»Ÿå¯èƒ½ä¼šæ¸…é™¤ä¸€ä¸ªä»æœªè¿‡æœŸçš„å¯¹è±¡ï¼Œä»è€Œé™ä½äº†ç¼“å­˜çš„å‘½ä¸­ç‡ã€‚å¯è¡Œçš„è§£å†³åŠæ³•æ˜¯ï¼šæé«˜ <code>NSCache</code> çš„ <code>totalCostLimit</code>ã€‚ç„¶è€Œè¿™ä¼šå¯¼è‡´ç¼“å­˜å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜å˜å¤§ï¼Œéœ€è¦è‡ªå·±æŠŠæ¡è¿™ä¹‹é—´çš„å¹³è¡¡ã€‚</p>
<p>å†…å­˜ç¼“å­˜çš„å¯¹è±¡é»˜è®¤çš„æœ‰æ•ˆæœŸæ˜¯ 5 åˆ†é’Ÿã€‚å…³äºç­–ç•¥ 2ï¼ŒKingfisher è®¾è®¡äº†ä¸€ä¸ª <code>timer</code> æ¥å‘¨æœŸæ€§ï¼ˆé»˜è®¤å‘¨æœŸä¸º 2 åˆ†é’Ÿï¼‰åœ°æ¸…é™¤è¿‡æœŸçš„ç¼“å­˜å¯¹è±¡ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cleanTimer <span class="operator">=</span> .scheduledTimer(withTimeInterval: config.cleanInterval, repeats: <span class="literal">true</span>) &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">_</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> <span class="operator">=</span> <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    <span class="keyword">self</span>.removeExpired()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">...</span></span><br><span class="line"><span class="operator">...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">removeExpired</span>() &#123;</span><br><span class="line">    lock.lock()</span><br><span class="line">    <span class="keyword">defer</span> &#123; lock.unlock() &#125;</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> keys &#123;</span><br><span class="line">        <span class="keyword">let</span> nsKey <span class="operator">=</span> key <span class="keyword">as</span> <span class="type">NSString</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> object <span class="operator">=</span> storage.object(forKey: nsKey) <span class="keyword">else</span> &#123;</span><br><span class="line">            keys.remove(key)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> object.estimatedExpiration.isPast &#123;</span><br><span class="line">            storage.removeObject(forKey: nsKey)</span><br><span class="line">            keys.remove(key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ç¡¬ç›˜ç¼“å­˜æ¸…é™¤ç­–ç•¥"><a href="#ç¡¬ç›˜ç¼“å­˜æ¸…é™¤ç­–ç•¥" class="headerlink" title="ç¡¬ç›˜ç¼“å­˜æ¸…é™¤ç­–ç•¥"></a>ç¡¬ç›˜ç¼“å­˜æ¸…é™¤ç­–ç•¥</h3><p>ç¡¬ç›˜ç¼“å­˜çš„å¯¹è±¡é»˜è®¤çš„æœ‰æ•ˆæœŸæ˜¯ 7 å¤©ï¼Œå…¶æ¸…é™¤ç­–ç•¥æ˜¯è‡ªå·±æ§åˆ¶çš„ã€‚<br>ç±»ä¼¼åœ°ï¼ŒKingfisher ä¹Ÿå¯¹ç¡¬ç›˜ç¼“å­˜çš„å¯ç”¨å®¹é‡åšäº†é™åˆ¶ï¼Œé€šè¿‡ <code>sizeLimit</code> æ¥æ§åˆ¶ã€‚ä½† Kingfisher åœ¨å¯¹è±¡å­˜å…¥ç¡¬ç›˜ç¼“å­˜æ—¶ï¼Œå¹¶æœªå¯¹å¯¹è±¡çš„å¤§å°åšæ£€æŸ¥ã€‚æˆ‘çš„çŒœæƒ³æ˜¯ä¸€æ–¹é¢æ˜¯å¯ä»¥æé«˜ç¼“å­˜çš„å‘½ä¸­ç‡ï¼Œå¦ä¸€æ–¹é¢æ˜¯æœ‰å…¶ä»–æ›´å¥½çš„æ—¶æœºæ¥æ ¸æŸ¥ç¼“å­˜å¯¹è±¡çš„å¤§å°ï¼Œå¹¶æ¸…é™¤è¿‡å¤§çš„ç¼“å­˜å¯¹è±¡ã€‚</p>
<p>å¦‚æœ app è¿›å…¥äº† <code>UIApplication.State.background</code> çŠ¶æ€ï¼ŒKingfisher å°±ä¼šå¼€å§‹æ¸…ç†è¿‡æœŸçš„å¯¹è±¡å’Œè¿‡å¤§çš„ç¼“å­˜å¯¹è±¡ã€‚</p>
<p>æ¸…ç†è¿‡æœŸå¯¹è±¡çš„åšæ³•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">removeExpiredValues</span>(<span class="params">referenceDate</span>: <span class="type">Date</span>) <span class="keyword">throws</span> -&gt; [<span class="type">URL</span>] &#123;</span><br><span class="line">    <span class="keyword">let</span> propertyKeys: [<span class="type">URLResourceKey</span>] <span class="operator">=</span> [</span><br><span class="line">        .isDirectoryKey,</span><br><span class="line">        .contentModificationDateKey</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> urls <span class="operator">=</span> <span class="keyword">try</span> allFileURLs(for: propertyKeys)</span><br><span class="line">    <span class="keyword">let</span> keys <span class="operator">=</span> <span class="type">Set</span>(propertyKeys)</span><br><span class="line">    <span class="keyword">let</span> expiredFiles <span class="operator">=</span> urls.filter &#123; fileURL <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> meta <span class="operator">=</span> <span class="keyword">try</span> <span class="type">FileMeta</span>(fileURL: fileURL, resourceKeys: keys)</span><br><span class="line">            <span class="keyword">if</span> meta.isDirectory &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> meta.expired(referenceDate: referenceDate)</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> expiredFiles.forEach &#123; url <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">try</span> removeFile(at: url)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> expiredFiles</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>æ¸…ç†è¿‡å¤§å¯¹è±¡çš„åšæ³•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">removeSizeExceededValues</span>() <span class="keyword">throws</span> -&gt; [<span class="type">URL</span>] &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> config.sizeLimit <span class="operator">==</span> <span class="number">0</span> &#123; <span class="keyword">return</span> [] &#125; <span class="comment">// 0 æ„å‘³ç€æ— å¤§å°é™åˆ¶ã€‚</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> size <span class="operator">=</span> <span class="keyword">try</span> totalSize()</span><br><span class="line">    <span class="keyword">if</span> size <span class="operator">&lt;</span> config.sizeLimit &#123; <span class="keyword">return</span> [] &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> propertyKeys: [<span class="type">URLResourceKey</span>] <span class="operator">=</span> [</span><br><span class="line">        .isDirectoryKey,</span><br><span class="line">        .creationDateKey,</span><br><span class="line">        .fileSizeKey</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">let</span> keys <span class="operator">=</span> <span class="type">Set</span>(propertyKeys)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> urls <span class="operator">=</span> <span class="keyword">try</span> allFileURLs(for: propertyKeys)</span><br><span class="line">    <span class="keyword">var</span> pendings: [<span class="type">FileMeta</span>] <span class="operator">=</span> urls.compactMap &#123; fileURL <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> meta <span class="operator">=</span> <span class="keyword">try?</span> <span class="type">FileMeta</span>(fileURL: fileURL, resourceKeys: keys) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> meta</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»¥ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´ä»å¤§åˆ°å°æ’åºï¼Œæœ€è¿‘è®¿é—®çš„å¯¹è±¡æ’åœ¨æœ€å‰ã€‚</span></span><br><span class="line">    pendings.sort(by: <span class="type">FileMeta</span>.lastAccessDate)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> removed: [<span class="type">URL</span>] <span class="operator">=</span> []</span><br><span class="line">    <span class="keyword">let</span> target <span class="operator">=</span> config.sizeLimit <span class="operator">/</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> size <span class="operator">&gt;</span> target, <span class="keyword">let</span> meta <span class="operator">=</span> pendings.popLast() &#123;</span><br><span class="line">        size <span class="operator">-=</span> <span class="type">UInt</span>(meta.fileSize)</span><br><span class="line">        <span class="keyword">try</span> removeFile(at: meta.url)</span><br><span class="line">        removed.append(meta.url)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> removed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ã€Œæ¸…ç†è¿‡å¤§å¯¹è±¡ã€è¿™ä¸ªè¯´æ³•å…¶å®æœ‰äº›æ¨¡ç³Šï¼Œæ›´å‡†ç¡®åœ°è¯´æ˜æ˜¯ï¼šå¦‚æœå½“å‰ç¡¬ç›˜ç¼“å­˜çš„å®¹é‡å¤§äº <code>sizeLimit</code>ï¼Œåˆ™æ ¹æ®å¯¹è±¡çš„ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´è¿›è¡Œæ’åºï¼Œæœ€è¿‘è®¿é—®çš„å¯¹è±¡æ’åœ¨å‰é¢ã€‚Kingfisher çš„åšæ³•æ˜¯ï¼šä»æœ€ä¸ç»å¸¸è®¿é—®çš„å¯¹è±¡å¼€å§‹åˆ é™¤ï¼Œç›´åˆ°å½“å‰å­˜å‚¨çš„å¯¹è±¡çš„æ€»å¤§å°ç¼©å‡è‡³ä¸€åŠåŠå…¶ä»¥ä¸‹ï¼Œæ‰åœæ­¢åˆ é™¤ã€‚è¿™æ˜¯ç»å…¸çš„ LRU ç¼“å­˜æ·˜æ±°ç®—æ³•ã€‚</p>
<h2 id="å‡ºé”™å¤„ç†"><a href="#å‡ºé”™å¤„ç†" class="headerlink" title="å‡ºé”™å¤„ç†"></a>å‡ºé”™å¤„ç†</h2><p>Kingfisher æŠŠè‡ªèº«æ¨¡å—å†…çš„é”™è¯¯ç»†åˆ†ä¸º 5 ç±»ï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Represents the error reason during networking request phase.</span></span><br><span class="line"><span class="keyword">case</span> requestError(reason: <span class="type">RequestErrorReason</span>)</span><br><span class="line"><span class="comment">/// Represents the error reason during networking response phase.</span></span><br><span class="line"><span class="keyword">case</span> responseError(reason: <span class="type">ResponseErrorReason</span>)</span><br><span class="line"><span class="comment">/// Represents the error reason during Kingfisher caching system.</span></span><br><span class="line"><span class="keyword">case</span> cacheError(reason: <span class="type">CacheErrorReason</span>)</span><br><span class="line"><span class="comment">/// Represents the error reason during image processing phase.</span></span><br><span class="line"><span class="keyword">case</span> processorError(reason: <span class="type">ProcessorErrorReason</span>)</span><br><span class="line"><span class="comment">/// Represents the error reason during image setting in a view related class.</span></span><br><span class="line"><span class="keyword">case</span> imageSettingError(reason: <span class="type">ImageSettingErrorReason</span>)</span><br></pre></td></tr></table></figure>
<p>æ¯ç±»é”™è¯¯è¿˜ä¼šæºå¸¦å¯¹åº”å‡ºé”™åŸå› ã€‚ä»é”™è¯¯çš„åˆ†ç±»ï¼Œå¯ä»¥å¤§è‡´çœ‹å‡º Kingfisher åˆ†ä¸ºå›¾ç‰‡ä¸‹è½½æ¨¡å—ã€å›¾ç‰‡ç¼“å­˜æ¨¡å—ã€å›¾ç‰‡å¤„ç†æ¨¡å—ç­‰æ¨¡å—ã€‚</p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>åœ¨é˜…è¯» Kingfisher ç¼“å­˜ç³»ç»Ÿç›¸å…³ä»£ç æ—¶ï¼Œæˆ‘è¿˜å‘ç°äº†å…¶ä»–å€¼å¾—å­¦ä¹ çš„ä»£ç ï¼Œä¸€å¹¶è®°å½•ã€‚</p>
<h3 id="ç½‘ç»œè¯·æ±‚é‡è¯•æœºåˆ¶"><a href="#ç½‘ç»œè¯·æ±‚é‡è¯•æœºåˆ¶" class="headerlink" title="ç½‘ç»œè¯·æ±‚é‡è¯•æœºåˆ¶"></a>ç½‘ç»œè¯·æ±‚é‡è¯•æœºåˆ¶</h3><p><img src="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_02.png" alt="kf_02.001"><br>Kingfisher è®¾è®¡ä¸€ä¸ª <code>RetryStrategy</code> åè®®ï¼Œç”±éµå¾ªè¯¥åè®®çš„å¯¹è±¡æ¥ä½œå‡ºå†³å®šï¼ˆ<code>RetryDecision</code>ï¼‰ã€‚<code>RetryDecision</code> æœ‰ä¸¤ç§ï¼šç»§ç»­é‡è¯•å’Œåœæ­¢é‡è¯•ã€‚</p>
<p>éµå¾ª <code>RetryStrategy</code> åè®®çš„å¯¹è±¡å†…éƒ¨è®¾è®¡äº†ä¸‰ç§é‡è¯•æ¨¡å¼ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> <span class="title class_">DelayRetryStrategy</span>: <span class="title class_ inherited__">RetryStrategy</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Interval</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> seconds(<span class="type">TimeInterval</span>) <span class="comment">// æŒ‡å®š n ç§’åé‡è¯•</span></span><br><span class="line">        <span class="keyword">case</span> accumulated(<span class="type">TimeInterval</span>) <span class="comment">// æŒ‡å®š n ç§’ä»¥ç´¯åŠ çš„æ–¹å¼é‡è¯•ï¼Œä¾‹å¦‚ç¬¬ä¸€æ¬¡ä¸º 3s åé‡è¯•ï¼Œç¬¬äºŒæ¬¡å°±æ˜¯ 6s åé‡è¯•ï¼Œä»¥æ­¤ç±»æ¨ã€‚</span></span><br><span class="line">        <span class="keyword">case</span> custom(block: (<span class="keyword">_</span> retriedCount: <span class="type">Int</span>) -&gt; <span class="type">TimeInterval</span>) <span class="comment">// å‘Šè¯‰ä½ å·²ç»é‡è¯•çš„æ¬¡æ•°ï¼Œè‡ªè¡Œå†³å®šå‡ ç§’åè¿›è¡Œé‡è¯•</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">func</span> <span class="title function_">timeInterval</span>(<span class="params">for</span> <span class="params">retriedCount</span>: <span class="type">Int</span>) -&gt; <span class="type">TimeInterval</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> retryAfter: <span class="type">TimeInterval</span></span><br><span class="line">            <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">                <span class="keyword">case</span> .seconds(<span class="keyword">let</span> interval):</span><br><span class="line">                retryAfter <span class="operator">=</span> interval</span><br><span class="line">                <span class="keyword">case</span> .accumulated(<span class="keyword">let</span> interval):</span><br><span class="line">                retryAfter <span class="operator">=</span> <span class="type">Double</span>(retriedCount <span class="operator">+</span> <span class="number">1</span>) <span class="operator">*</span> interval</span><br><span class="line">                <span class="keyword">case</span> .custom(<span class="keyword">let</span> block):</span><br><span class="line">                retryAfter <span class="operator">=</span> block(retriedCount)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> retryAfter</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶æ ¸å¿ƒæ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">retry</span>(<span class="params">context</span>: <span class="type">RetryContext</span>, <span class="params">retryHandler</span>: <span class="keyword">@escaping</span> (<span class="type">RetryDecision</span>) -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="comment">// è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œåœæ­¢é‡è¯•</span></span><br><span class="line">    <span class="keyword">guard</span> context.retriedCount <span class="operator">&lt;</span> maxRetryCount <span class="keyword">else</span> &#123;</span><br><span class="line">        retryHandler(.stop)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å½“å‡ºé”™åŸå› æ˜¯ç”¨æˆ·å–æ¶ˆè¯¥ä»»åŠ¡æ—¶ï¼Œä¸è¿›è¡Œé‡è¯•</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="operator">!</span>context.error.isTaskCancelled <span class="keyword">else</span> &#123;</span><br><span class="line">        retryHandler(.stop)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»…åœ¨ç½‘ç»œè¯·æ±‚å“åº”å‡ºé”™æ—¶ï¼Œè¿›è¡Œé‡è¯•</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">case</span> <span class="type">KingfisherError</span>.responseError <span class="operator">=</span> context.error <span class="keyword">else</span> &#123;</span><br><span class="line">        retryHandler(.stop)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®å½“å‰æ‰€ä½¿ç”¨çš„é‡è¯•ç­–ç•¥ï¼Œç»“åˆå½“å‰å·²é‡è¯•æ¬¡æ•°ï¼Œè®¡ç®—å‡º interval ç§’åè¿›è¡Œé‡è¯•</span></span><br><span class="line">    <span class="keyword">let</span> interval <span class="operator">=</span> retryInterval.timeInterval(for: context.retriedCount)</span><br><span class="line">    <span class="keyword">if</span> interval <span class="operator">==</span> <span class="number">0</span> &#123; <span class="comment">// ç«‹å³è¿›è¡Œé‡è¯•</span></span><br><span class="line">        retryHandler(.retry(userInfo: <span class="literal">nil</span>))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å»¶è¿Ÿ interval ç§’åï¼Œæäº¤é‡è¯•ä»»åŠ¡ã€‚</span></span><br><span class="line">        <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: .now() <span class="operator">+</span> interval) &#123;</span><br><span class="line">            retryHandler(.retry(userInfo: <span class="literal">nil</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å§”æ‰˜æ¨¡å¼"><a href="#å§”æ‰˜æ¨¡å¼" class="headerlink" title="å§”æ‰˜æ¨¡å¼"></a>å§”æ‰˜æ¨¡å¼</h3><p>iOS å¼€å‘è€…æœ€ç†Ÿæ‚‰çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€å°±æ˜¯ <code>Delegate</code>ï¼Œå¸¸è§äº <code>UITableViewDelegate</code> ç­‰ã€‚<br>å¹³æ—¶è‡ªå®šä¹‰çš„ç±»æœ‰æ—¶ä¹Ÿéœ€è¦æŠŠæŸä¸ªæ–¹æ³•çš„å®ç°å§”æ‰˜ç»™å¦ä¸€ä¸ªç±»å»å®ç°ã€‚<br>ä¾‹å¦‚ï¼Œ<code>Task</code> çš„ <code>finish(taskID: String)</code> æ–¹æ³•éœ€è¦äº¤ç»™å¤–éƒ¨å»å®ç°ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> onFinished: ((<span class="type">String</span>) -&gt; <span class="type">String</span>?)<span class="operator">?</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">finish</span>(<span class="params">taskID</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> string <span class="operator">=</span> onFinished<span class="operator">?</span>(taskID)</span><br><span class="line">        <span class="built_in">print</span>(<span class="type">String</span>(describing: string))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KFViewController</span>: <span class="title class_ inherited__">UIViewController</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> subtaskAmount <span class="operator">=</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">let</span> task <span class="operator">=</span> <span class="type">Task</span>()</span><br><span class="line">        task.onFinished <span class="operator">=</span> &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] taskID <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> <span class="operator">=</span> <span class="keyword">self</span> <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> string <span class="operator">=</span> <span class="string">&quot;Task <span class="subst">\(taskID)</span> is finished, the number of subtasks is <span class="subst">\(<span class="keyword">self</span>.subtaskAmount)</span>&quot;</span></span><br><span class="line">            <span class="keyword">return</span> string</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¾“å‡ºï¼šOptional(&quot;Task 123 is finished, the number of subtasks is 3&quot;)</span></span><br><span class="line">        task.finish(taskID: <span class="string">&quot;123&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="operator">...</span></span><br><span class="line">        <span class="operator">...</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿™æ ·çš„å†™æ³•æ˜¯å¯è¡Œçš„ï¼Œä½†æ¯æ¬¡å¿…é¡»è®°å¾—åœ¨ <code>onFinished</code> é—­åŒ…ä¸­å¼±å¼•ç”¨ <code>self</code> ä»¥å…å‡ºç°å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p>
<p>Kingfisher ä¸­æœ‰è¿™æ ·ä¸€ä¸ªå¥½ç”¨çš„å·¥å…·ç±»ï¼š<code>class Delegate&lt;Input, Output&gt;</code>ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Delegate</span>&lt;<span class="type">Input</span>, <span class="type">Output</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> block: ((<span class="type">Input</span>) -&gt; <span class="type">Output</span>?)<span class="operator">?</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">delegate</span>&lt;<span class="type">T</span>: <span class="type">AnyObject</span>&gt;(<span class="params">on</span> <span class="params">target</span>: <span class="type">T</span>, <span class="params">block</span>: ((<span class="type">T</span>, <span class="type">Input</span>) -&gt; <span class="type">Output</span>)<span class="operator">?</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.block <span class="operator">=</span> &#123; [<span class="keyword">weak</span> target] input <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> target <span class="operator">=</span> target <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">            <span class="keyword">return</span> block<span class="operator">?</span>(target, input)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">call</span>(<span class="keyword">_</span> <span class="params">input</span>: <span class="type">Input</span>) -&gt; <span class="type">Output</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> block<span class="operator">?</span>(input)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">callAsFunction</span>(<span class="keyword">_</span> <span class="params">input</span>: <span class="type">Input</span>) -&gt; <span class="type">Output</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> call(input)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å€ŸåŠ©è¿™ä¸ªå·¥å…·ç±»ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¼˜åŒ–åçš„ç‰ˆæœ¬ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> onFinished <span class="operator">=</span> <span class="type">Delegate</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">finish</span>(<span class="keyword">_</span> <span class="params">taskID</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> string <span class="operator">=</span> onFinished.call(taskID)</span><br><span class="line">        <span class="built_in">print</span>(<span class="type">String</span>(describing: string))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KFViewController</span>: <span class="title class_ inherited__">UIViewController</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> subtaskAmount <span class="operator">=</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> task <span class="operator">=</span> <span class="type">Task</span>()</span><br><span class="line">        task.onFinished.delegate(on: <span class="keyword">self</span>) &#123; (<span class="keyword">self</span>, taskID) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> string <span class="operator">=</span> <span class="string">&quot;Task <span class="subst">\(taskID)</span> is finished, the amount of its subtask is <span class="subst">\(<span class="keyword">self</span>.subtaskAmount)</span>&quot;</span></span><br><span class="line">            <span class="keyword">return</span> string</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        task.finish(<span class="string">&quot;123&quot;</span>)</span><br><span class="line">        <span class="operator">...</span></span><br><span class="line">        <span class="operator">...</span></span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢ç¬¬äºŒä¸ª <code>self</code> å·²æ˜¯å¼±å¼•ç”¨åçš„ç‰ˆæœ¬ï¼Œæ— éœ€æ¯æ¬¡å¾—åŠ  <code>weak</code> å…³é”®å­—äº†ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">task.onFinished.delegate(on: <span class="keyword">self</span>) &#123; (<span class="keyword">self</span>, taskID) <span class="keyword">in</span></span><br></pre></td></tr></table></figure>
<p>å†è€…ï¼ŒæŠŠåŒ¿åå‡½æ•°ï¼ˆClosureï¼‰åŒ…è£…æˆä¸€ä¸ª <code>Delegate</code> å¯¹è±¡ä½¿ç”¨ä½¿å¾—ä»£ç æ›´åŠ æ¸…æ™°ã€‚</p>
<h4 id="æé—®-1ï¼šä¸ºå•¥-onFinished-call-taskID-è¿”å›çš„æ˜¯å¯é€‰ç±»å‹-Stringï¼Ÿ"><a href="#æé—®-1ï¼šä¸ºå•¥-onFinished-call-taskID-è¿”å›çš„æ˜¯å¯é€‰ç±»å‹-Stringï¼Ÿ" class="headerlink" title="æé—® 1ï¼šä¸ºå•¥ onFinished.call(taskID) è¿”å›çš„æ˜¯å¯é€‰ç±»å‹ Stringï¼Ÿ"></a>æé—® 1ï¼šä¸ºå•¥ onFinished.call(taskID) è¿”å›çš„æ˜¯å¯é€‰ç±»å‹ Stringï¼Ÿ</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œçš„æ³›å‹çº¦æŸæ˜æ˜æ˜¯ String ç±»å‹</span></span><br><span class="line"><span class="keyword">var</span> onFinished <span class="operator">=</span> <span class="type">Delegate</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt;()</span><br></pre></td></tr></table></figure>
<p>å› ä¸º <code>Delegate</code> å†…éƒ¨å®ç°æ˜¯å¼±å¼•ç”¨ <code>self</code>ï¼Œæ‰€ä»¥ <code>self</code> å¤„äºä¸€ç§å¯èƒ½æœ‰å¯èƒ½æ²¡æœ‰çš„çŠ¶æ€ï¼Œè¿™å°±å¯¼è‡´è¿”å›å€¼çš„ç±»å‹å‡æ˜¯å¯é€‰ç±»å‹çš„äº†ã€‚</p>
<h4 id="æé—®-2-å¦‚æœæŠŠ-Output-æ³›å‹çº¦æŸä¸ºå¯é€‰ç±»å‹ï¼Œé‚£è¿”å›å€¼ç±»å‹ä¸å°±æ˜¯å¯é€‰çš„å¯é€‰ç±»å‹ï¼ˆ-ï¼‰å—ï¼Ÿ"><a href="#æé—®-2-å¦‚æœæŠŠ-Output-æ³›å‹çº¦æŸä¸ºå¯é€‰ç±»å‹ï¼Œé‚£è¿”å›å€¼ç±»å‹ä¸å°±æ˜¯å¯é€‰çš„å¯é€‰ç±»å‹ï¼ˆ-ï¼‰å—ï¼Ÿ" class="headerlink" title="æé—® 2: å¦‚æœæŠŠ Output æ³›å‹çº¦æŸä¸ºå¯é€‰ç±»å‹ï¼Œé‚£è¿”å›å€¼ç±»å‹ä¸å°±æ˜¯å¯é€‰çš„å¯é€‰ç±»å‹ï¼ˆ??ï¼‰å—ï¼Ÿ"></a>æé—® 2: å¦‚æœæŠŠ Output æ³›å‹çº¦æŸä¸ºå¯é€‰ç±»å‹ï¼Œé‚£è¿”å›å€¼ç±»å‹ä¸å°±æ˜¯å¯é€‰çš„å¯é€‰ç±»å‹ï¼ˆ??ï¼‰å—ï¼Ÿ</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Delegate</span>&lt;<span class="type">Input</span>, <span class="type">Output</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> block: ((<span class="type">Input</span>) -&gt; <span class="type">Output</span>?)<span class="operator">?</span></span><br><span class="line">    <span class="operator">...</span></span><br><span class="line">    <span class="operator">...</span></span><br></pre></td></tr></table></figure>
<p>Kingfisher å·²å¯¹è¿™ç§æƒ…å†µåšäº†å¤„ç†ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">Delegate</span> <span class="keyword">where</span> <span class="type">Output</span>: <span class="type">OptionalProtocol</span> &#123;</span><br><span class="line">    <span class="comment">// æ­¤æ—¶ Output çš„ç±»å‹ä¸ºå¯é€‰ç±»å‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">call</span>(<span class="keyword">_</span> <span class="params">input</span>: <span class="type">Input</span>) -&gt; <span class="type">Output</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> result <span class="operator">=</span> block<span class="operator">?</span>(input) &#123;</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="type">Output</span>._createNil</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">callAsFunction</span>(<span class="keyword">_</span> <span class="params">input</span>: <span class="type">Input</span>) -&gt; <span class="type">Output</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> call(input)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">protocol</span> <span class="title class_">OptionalProtocol</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> _createNil: <span class="keyword">Self</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Optional</span> : <span class="title class_ inherited__">OptionalProtocol</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> _createNil: <span class="type">Optional</span>&lt;<span class="type">Wrapped</span>&gt; &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ <code>Output</code> ç±»å‹ä¸ºå¯é€‰ç±»å‹æ—¶ï¼Œæ–°å¢ä¸€ä¸ªç›´æ¥è¿”å› <code>Output</code> çš„ <code>call</code> æ–¹æ³•ã€‚</p>
<p>Kingfisher è¿˜ä½¿ç”¨äº† Swift <code>callAsFunction</code> çš„æ–°ç‰¹æ€§ï¼Œè¿™æ„å‘³ç€å¯ä»¥æ— éœ€å†è°ƒç”¨ <code>call</code> æ–¹æ³•ï¼Œå¦‚ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> onFinished <span class="operator">=</span> <span class="type">Delegate</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">finish</span>(<span class="keyword">_</span> <span class="params">taskID</span>: <span class="type">String</span>) &#123;</span><br><span class="line"><span class="comment">//        let string = onFinished.call(taskID)</span></span><br><span class="line">        <span class="comment">/// åˆ©ç”¨ callAsFunction çš„ç‰¹æ€§</span></span><br><span class="line">        <span class="keyword">let</span> string <span class="operator">=</span> onFinished(taskID)</span><br><span class="line">        <span class="built_in">print</span>(<span class="type">String</span>(describing: string))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CacheCallbackCoordinator"><a href="#CacheCallbackCoordinator" class="headerlink" title="CacheCallbackCoordinator"></a>CacheCallbackCoordinator</h3><p>é¡¾åæ€ä¹‰å°±æ˜¯ç¼“å­˜æ¨¡å—å†…çš„å¼‚æ­¥å›è°ƒæ–¹æ³•çš„åè°ƒå™¨ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ˜¯å¦éœ€è¦ç¼“å­˜åŸå§‹å›¾ç‰‡</span></span><br><span class="line"><span class="keyword">let</span> needToCacheOriginalImage <span class="operator">=</span> options.cacheOriginalImage <span class="operator">&amp;&amp;</span></span><br><span class="line">options.processor <span class="operator">!=</span> <span class="type">DefaultImageProcessor</span>.default</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> coordinator <span class="operator">=</span> <span class="type">CacheCallbackCoordinator</span>(</span><br><span class="line">    shouldWaitForCache: options.waitForCache, shouldCacheOriginal: needToCacheOriginalImage)</span><br><span class="line"><span class="keyword">let</span> result <span class="operator">=</span> <span class="type">RetrieveImageResult</span>(</span><br><span class="line">    image: options.imageModifier<span class="operator">?</span>.modify(value.image) <span class="operator">??</span> value.image,</span><br><span class="line">    cacheType: .none,</span><br><span class="line">    source: source,</span><br><span class="line">    originalSource: context.originalSource</span><br><span class="line">)</span><br><span class="line"><span class="comment">// Add image to cache.</span></span><br><span class="line"><span class="keyword">let</span> targetCache <span class="operator">=</span> options.targetCache <span class="operator">??</span> <span class="keyword">self</span>.cache</span><br><span class="line">targetCache.store(</span><br><span class="line">    value.image,</span><br><span class="line">    original: value.originalData,</span><br><span class="line">    forKey: source.cacheKey,</span><br><span class="line">    options: options,</span><br><span class="line">    toDisk: <span class="operator">!</span>options.cacheMemoryOnly)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">_</span> <span class="keyword">in</span></span><br><span class="line">    coordinator.apply(.cachingImage) &#123;</span><br><span class="line">        completionHandler<span class="operator">?</span>(.success(result))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> needToCacheOriginalImage &#123;</span><br><span class="line">    <span class="keyword">let</span> originalCache <span class="operator">=</span> options.originalCache <span class="operator">??</span> targetCache</span><br><span class="line">    originalCache.storeToDisk(</span><br><span class="line">        value.originalData,</span><br><span class="line">        forKey: source.cacheKey,</span><br><span class="line">        processorIdentifier: <span class="type">DefaultImageProcessor</span>.default.identifier,</span><br><span class="line">        expiration: options.diskCacheExpiration)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">_</span> <span class="keyword">in</span></span><br><span class="line">        coordinator.apply(.cachingOriginalImage) &#123;</span><br><span class="line">            completionHandler<span class="operator">?</span>(.success(result))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">coordinator.apply(.cacheInitiated) &#123;</span><br><span class="line">    completionHandler<span class="operator">?</span>(.success(result))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ‰ä¸¤ä¸ªå¸ƒå°”å€¼åœ¨æ§åˆ¶ <code>completionHandler?(.success(result))</code> æ‰§è¡Œçš„æ—¶æœºï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li>æ˜¯å¦éœ€è¦ç¼“å­˜åŸå§‹å›¾ç‰‡ï¼ˆneedToCacheOriginalImageï¼‰</li>
<li>æ˜¯å¦ç­‰å¾…ç¼“å­˜è¿‡ç¨‹ç»“æŸï¼ˆshouldWaitForCacheï¼‰</li>
</ol>
<p>åœ¨è¿™ä¸¤ä¸ªå˜é‡çš„æ’åˆ—ç»„åˆä¸‹ï¼ŒKingfisher éœ€è¦ç¡®ä¿è¯¥å›è°ƒæ‰§è¡Œçš„æ¬¡æ•°<strong>æœ‰ä¸”åªæœ‰ä¸€æ¬¡ï¼</strong></p>
<p>å› æ­¤ï¼Œ<code>CacheCallbackCoordinator</code> å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒ…å«å››ç§çŠ¶æ€çš„æšä¸¾ <code>State</code>ã€å¯¼è‡´çŠ¶æ€å‘ç”Ÿè½¬ç§»çš„ä¸‰ç§ <code>Action</code>ï¼Œä»¥åŠæè¿°çŠ¶æ€æ˜¯å¦‚ä½•è½¬ç§»çš„ <code>apply</code> æ–¹æ³•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">State</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> idle</span><br><span class="line">    <span class="keyword">case</span> imageCached</span><br><span class="line">    <span class="keyword">case</span> originalImageCached</span><br><span class="line">    <span class="keyword">case</span> done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Action</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> cacheInitiated</span><br><span class="line">    <span class="keyword">case</span> cachingImage</span><br><span class="line">    <span class="keyword">case</span> cachingOriginalImage</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">apply</span>(<span class="keyword">_</span> <span class="params">action</span>: <span class="type">Action</span>, <span class="params">trigger</span>: () -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (state, action) &#123;</span><br><span class="line">        <span class="keyword">case</span> (.done, <span class="keyword">_</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From .idle</span></span><br><span class="line">        <span class="keyword">case</span> (.idle, .cacheInitiated):</span><br><span class="line">        <span class="keyword">if</span> <span class="operator">!</span>shouldWaitForCache &#123;</span><br><span class="line">            state <span class="operator">=</span> .done</span><br><span class="line">            trigger()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> (.idle, .cachingImage):</span><br><span class="line">        <span class="keyword">if</span> shouldCacheOriginal &#123;</span><br><span class="line">            state <span class="operator">=</span> .imageCached</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            state <span class="operator">=</span> .done</span><br><span class="line">            trigger()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> (.idle, .cachingOriginalImage):</span><br><span class="line">        state <span class="operator">=</span> .originalImageCached</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From .imageCached</span></span><br><span class="line">        <span class="keyword">case</span> (.imageCached, .cachingOriginalImage):</span><br><span class="line">        state <span class="operator">=</span> .done</span><br><span class="line">        trigger()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From .originalImageCached</span></span><br><span class="line">        <span class="keyword">case</span> (.originalImageCached, .cachingImage):</span><br><span class="line">        state <span class="operator">=</span> .done</span><br><span class="line">        trigger()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">assertionFailure</span>(<span class="string">&quot;This case should not happen in CacheCallbackCoordinator: <span class="subst">\(state)</span> - <span class="subst">\(action)</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰äº†è¿™äº›ï¼Œä¾¿å¯ä»¥ç”»å‡ºä¸€ä¸ªæœ‰é™çŠ¶æ€æœºçš„çŠ¶æ€è½¬ç§»å›¾ï¼š<img src="https://imagebed-1301918945.cos.ap-shanghai.myqcloud.com/2022/kf_03.png" alt="CacheCallbackCoordinator çŠ¶æ€æœº"><br>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼šåœ¨ä» <code>idle</code> çŠ¶æ€åˆ° <code>done</code> çŠ¶æ€çš„ä»»æ„ä¸€æ¡è·¯çº¿ä¸Šï¼Œ<code>trigger</code> æ–¹æ³•çš„æ‰§è¡Œæ¬¡æ•°<strong>æœ‰ä¸”åªæœ‰ä¸€æ¬¡</strong>ï¼è¿™æ ·è®¾è®¡çš„ä»£ç æ¸…æ™°ï¼Œä¹Ÿå®¹æ˜“æµ‹è¯•ï¼Œæ˜¯å¾ˆå€¼å¾—å­¦ä¹ çš„æ¡ˆä¾‹äº†ï¼</p>
<h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>è¯» Kingfisher æºç è¦åˆ†äº«çš„ç¬¬ä¸€éƒ¨åˆ†å°±åˆ°æ­¤ç»“æŸäº†ï¼Œè¿˜æœ‰å›¾ç‰‡ä¸‹è½½æµç¨‹ã€å›¾ç‰‡å¤„ç†æµç¨‹ã€å¯¹å¤šå¹³å°çš„æ”¯æŒï¼ˆKingfisher è¿˜æ”¯æŒ watchOSã€tvOS å’Œ macOSï¼‰ç­‰ã€‚</p>
<p>è¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ¯”è¾ƒè®¤çœŸåœ°èŠ±å¤§æ®µæ—¶é—´ä»”ç»†è¯»å¼€æºä»£ç ï¼Œæ”¶è·é¢‡ä¸°ã€‚</p>
<p>å°±è¿™æ ·æ…¢æ…¢è¿›æ­¥å§ï¼</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kingfisher/" rel="tag"># Kingfisher</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/08/09/WWDC%2021%2010267%20%E4%B8%80%E7%AA%A5%20Xcode%20Cloud/" rel="prev" title="WWDC21 10267 ä¸€çª¥ Xcode Cloud">
                  <i class="fa fa-angle-left"></i> WWDC21 10267 ä¸€çª¥ Xcode Cloud
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/03/30/%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%20iOS%20App%20CI%20%E7%B3%BB%E7%BB%9F/" rel="next" title="æ‰“é€ ä¸€ä¸ªç®€å•çš„ iOS App CI ç³»ç»Ÿ">
                  æ‰“é€ ä¸€ä¸ªç®€å•çš„ iOS App CI ç³»ç»Ÿ <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-user"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sunset Wan</span>
  </div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
